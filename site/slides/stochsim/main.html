<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Qianying (Ruby) Lin">
<meta name="author" content="Spencer J. Fox">
<meta name="author" content="Zian (Larry) Zhuang">

<title>Lesson 2: Simulation of stochastic dynamic models – EpiSim</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
MathJax = {
  loader: {
    load: ['[tex]/boldsymbol']
  },
  tex: {
    tags: "all",
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    packages: {
      '[+]': ['boldsymbol']
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">EpiSim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../instruction.html"> 
<span class="menu-text">Instruction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../simulation.html"> 
<span class="menu-text">Simulation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../likelihood.html"> 
<span class="menu-text">Likelihood</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../iterated.html"> 
<span class="menu-text">Iterated filtering</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Bayesian.html"> 
<span class="menu-text">Bayesian</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../case study.html"> 
<span class="menu-text">Case study</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    <div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="main.pdf"><i class="bi bi-file-pdf"></i>Beamer</a></li><li><a href="main.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lesson 2: Simulation of stochastic dynamic models</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Qianying (Ruby) Lin </p>
             <p>Spencer J. Fox </p>
             <p>Zian (Larry) Zhuang </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="objectives" class="level2">
<h2 class="anchored" data-anchor-id="objectives">Objectives</h2>
<p>This tutorial develops some classes of dynamic models relevant to biological systems, especially for epidemiology.</p>
<ol type="1">
<li>Dynamic systems can often be represented in terms of <em>flows</em> between <em>compartments</em>.</li>
<li>We develop the concept of a <em>compartment model</em> for which we specify <em>rates</em> for the flows between compartments.</li>
<li>We show how deterministic and stochastic versions of a compartment model are derived and related.</li>
<li>We introduce Euler’s method to simulate from dynamic models.</li>
<li>We specify deterministic and stochastic compartment models in pomp using Euler method simulation.</li>
</ol>
</section>
<section id="compartmental-models" class="level1">
<h1>Compartmental models</h1>
</section>
<section id="example-the-sir-model" class="level1">
<h1>Example: the SIR model</h1>
<section id="a-basic-compartment-model-the-sir-model" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="a-basic-compartment-model-the-sir-model">A basic compartment model: The SIR model</h2>
<ul>
<li><p>We develop deterministic and stochastic representations of a susceptible-infected-recovered (SIR) system, a fundamental class of models for disease transmission dynamics.</p></li>
<li><p>We set up notation applicable to general compartment models <span class="citation" data-cites="Breto2009">(<a href="#ref-Breto2009" role="doc-biblioref">Bretó et al. 2009</a>)</span>. </p></li>
</ul>
<ul>
<li><p>We suppose that each arrow has an associated rate, so here there is a rate <span class="math inline">\(\mu_{SI}(t)\)</span> at which individuals in <span class="math inline">\(S\)</span> transition to <span class="math inline">\(I\)</span>, and <span class="math inline">\(\mu_{IR}\)</span> at which individuals in <span class="math inline">\(I\)</span> transition to <span class="math inline">\(R\)</span>.</p></li>
<li><p>To account for demography (births/deaths/migration) we allow the possibility of a source and sink compartment, which is not usually represented on the flow diagram. We write <span class="math inline">\(\mu_{BS}\)</span> for a rate of births into <span class="math inline">\(S\)</span>, and denote mortality rates by <span class="math inline">\(\mu_{SD}\)</span>, <span class="math inline">\(\mu_{ID}\)</span>, <span class="math inline">\(\mu_{RD}\)</span>.</p></li>
<li><p>The rates may be either constant or time-varying.</p></li>
<li><p>For the simplest SIR model, ignoring demography, we set <span class="math display">\[ \mu_{BS}=\mu_{SD}=\mu_{ID}=\mu_{RD}=0.\]</span></p></li>
</ul>
</section>
</section>
<section id="notation" class="level1">
<h1>Notation</h1>
<section id="general-notation-for-compartment-models" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="general-notation-for-compartment-models">General notation for compartment models</h2>
<p>To develop a systematic notation, it turns out to be convenient to keep track of the flows between compartments as well as the number of individuals in each compartment:</p>
<ul>
<li><p><span class="math inline">\(N_{SI}(t)\)</span>: the number of individuals who have transitioned from <span class="math inline">\(S\)</span> to <span class="math inline">\(I\)</span> <strong>by</strong> time <span class="math inline">\(t\)</span>. We say that <span class="math inline">\(N_{SI}(t)\)</span> is a <em>counting process</em>.</p></li>
<li><p><span class="math inline">\(N_{IR}(t)\)</span>: the number of individuals transitioning from <span class="math inline">\(I\)</span> to <span class="math inline">\(R\)</span> <strong>by</strong> time <span class="math inline">\(t\)</span>.</p></li>
</ul>
<p>To include demography, we could keep track of birth and death events by the counting processes:</p>
<ul>
<li><p><span class="math inline">\(N_{BS}(t)\)</span>: the number of newborns into <span class="math inline">\(S\)</span> <strong>by</strong> time <span class="math inline">\(t\)</span>.</p></li>
<li><p><span class="math inline">\(N_{SD}(t)\)</span>, <span class="math inline">\(N_{ID}(t)\)</span>, <span class="math inline">\(N_{RD}(t)\)</span>: the number of deaths from <span class="math inline">\(S\)</span>, <span class="math inline">\(I\)</span>, and <span class="math inline">\(R\)</span> compartments <strong>by</strong> time <span class="math inline">\(t\)</span>, respectively.</p></li>
</ul>
<ul>
<li>For discrete population compartment models, the flow counting processes are non-decreasing and integer valued.</li>
<li>For continuous population compartment models, the flow counting processes are non-decreasing and real valued.</li>
</ul>
</section>
<section id="compartment-model-from-counting-processes" class="level2">
<h2 class="anchored" data-anchor-id="compartment-model-from-counting-processes">Compartment model from counting processes</h2>
<ul>
<li><p>The numbers of people in each compartment can be computed via these counting processes. Ignoring demography, we have: <span class="math display">\[\begin{equation*}
\begin{aligned}
   S(t) &amp;= S(0) - N_{SI}(t) &amp;\\
   I(t) &amp;= I(0) + N_{SI}(t) &amp;- N_{IR}(t) \\
   R(t) &amp;= R(0) &amp;+ N_{IR}(t)
\end{aligned}
\end{equation*}\]</span></p></li>
<li><p>These equations represent <em>conservation of individuals</em> or <em>what goes in must come out</em>.</p></li>
</ul>
<!-- # A deterministic interpretation -->
</section>
<section id="ordinary-differential-equation-interpretation" class="level2">
<h2 class="anchored" data-anchor-id="ordinary-differential-equation-interpretation">Ordinary differential equation interpretation</h2>
<p>Together with initial conditions specifying <span class="math inline">\(S(0)\)</span>, <span class="math inline">\(I(0)\)</span> and <span class="math inline">\(R(0)\)</span>, we just need to write down ordinary differential equations (ODEs) for the flow counting processes. These are: <span class="math display">\[\begin{equation*}
    \begin{aligned}
      \deriv{N_{SI}}{t} &amp;= \mu_{SI}(t)\,S(t)\\
      \deriv{N_{IR}}{t} &amp;= \mu_{IR}\,I(t)
    \end{aligned}
  \end{equation*}\]</span></p>
</section>
<section id="common-notation-for-a-deterministic-sir-model" class="level2">
<h2 class="anchored" data-anchor-id="common-notation-for-a-deterministic-sir-model">Common notation for a deterministic SIR model</h2>
<ul>
<li><span class="math inline">\(\beta\)</span>: transmission rate, encompasses the frequency of contacts and transmission probability between individuals</li>
<li><span class="math inline">\(\gamma\)</span>: recovery rate, rate that infected individuals become “uninfectious”
<ul>
<li>Duration of infectiousness on average is <span class="math inline">\(\frac{1}{\gamma}\)</span></li>
</ul></li>
<li><span class="math inline">\(S + I + R = N\)</span></li>
</ul>
</section>
<section id="common-notation-for-a-deterministic-sir-model---equations" class="level2">
<h2 class="anchored" data-anchor-id="common-notation-for-a-deterministic-sir-model---equations">Common notation for a deterministic SIR model - equations</h2>
<span class="math display">\[\begin{equation*}
\begin{aligned}
  \deriv{S}{t} &amp;= - \beta S \frac{I}{N}\\
  \deriv{I}{t} &amp;= \beta S \frac{I}{N} - \gamma * I \\
  \deriv{R}{t} &amp;= \gamma I
\end{aligned}
\end{equation*}\]</span>
</section>
<section id="common-notation-for-a-deterministic-sir-model---skeleton-code" class="level2">
<h2 class="anchored" data-anchor-id="common-notation-for-a-deterministic-sir-model---skeleton-code">Common notation for a deterministic SIR model - Skeleton code</h2>
<div class="columns">
<div class="column" style="width:40%;">
<span class="math display">\[\begin{equation*}
\begin{aligned}
  \deriv{S}{t} &amp;= - \beta S \frac{I}{N}\\
  \deriv{I}{t} &amp;= \beta S \frac{I}{N} - \gamma * I \\
  \deriv{R}{t} &amp;= \gamma I
\end{aligned}
\end{equation*}\]</span>
</div><div class="column" style="width:60%;">
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pomp)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="st">  DS = -Beta*S*I/N;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">  DI = Beta*S*I/N - I*Gamma;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">  DR = I*Gamma;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>) <span class="ot">-&gt;</span> sir_det_skel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="stochastic-simulations" class="level1">
<h1>Stochastic simulations</h1>
<section id="stochastic-differential-equations-sdes" class="level2">
<h2 class="anchored" data-anchor-id="stochastic-differential-equations-sdes">Stochastic Differential Equations (SDEs)</h2>
<ul>
<li><p>By including randomness in the ODE system, we can have the stochastic differential equation (SDE) system.</p></li>
<li><p>For example, for the ODE <span class="math inline">\(\deriv{x}{t}=h(x)\)</span>, a natural way to add stochastic variation is <span class="math display">\[
    \deriv{X}{t} = h(X)+\sigma\,\deriv{B}{t}
  \]</span> where <span class="math inline">\(\{B(t)\}\)</span> is Brownian motion and so <span class="math inline">\(dB/dt\)</span> is Brownian noise.</p></li>
</ul>
</section>
<section id="the-simple-counting-process-and-the-reactions" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="the-simple-counting-process-and-the-reactions">The simple counting process and the reactions</h2>
<ul>
<li><p>A deterministic SIR model has a fixed trajectory, indicating that the number of each compartment at any time is fixed with given parameters and intial states; thus the transitions between compartments are fixed at any time.</p></li>
<li><p>A stochastic SIR model, in the contrary, the trajectory and the transitions between compartments at any time are stochastic.</p></li>
<li><p>Recall <span class="math inline">\(N_{SI}(t)\)</span> and <span class="math inline">\(N_{IR}(t)\)</span> are counting processes, indicating the number of total individuals transitioned from <span class="math inline">\(S\)</span> to <span class="math inline">\(I\)</span> and <span class="math inline">\(I\)</span> to <span class="math inline">\(R\)</span> by time <span class="math inline">\(t\)</span>, respectively.</p></li>
<li><p>A <em>simple counting process</em> is one which cannot count more than one event at a time.</p></li>
</ul>
<ul>
<li><p>We then can relate the counting process to the common SIR reactions with the corresponding probabilities.</p></li>
<li><p>Note that we are using <a href="./exercises.html#exercise-little-o-notation"><em>little o notation</em></a> and we write <span class="math inline">\(h(\delta)=o(\delta)\)</span> to mean <span class="math inline">\(\lim_{\delta\to 0} \frac{h(\delta)}{\delta} = 0\)</span>.</p></li>
</ul>
<div id="tbl-stochproc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-stochproc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Relationship between the counting processes, the reactions, and the probabilities.
</figcaption>
<div aria-describedby="tbl-stochproc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 21%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th>Counting</th>
<th>Reaction</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(N_{SI}(t+\delta)=N_{SI}(t)+1\)</span></td>
<td><span class="math inline">\(S \to S - 1\)</span> <span class="math inline">\(I \to I + 1\)</span></td>
<td><span class="math inline">\(\beta S(t) I(t) \delta / N + o(\delta)\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(N_{SI}(t+\delta)=N_{SI}(t)\)</span></td>
<td></td>
<td><span class="math inline">\(1-\beta S(t) I(t) \delta / N + o(\delta)\)</span></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(N_{IR}(t+\delta)=N_{IR}(t)+1\)</span></td>
<td><span class="math inline">\(I \to I - 1\)</span> <span class="math inline">\(R \to R + 1\)</span></td>
<td><span class="math inline">\(\gamma I(t) \delta + o(\delta)\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(N_{IR}(t+\delta)=N_{IR}(t)\)</span></td>
<td></td>
<td><span class="math inline">\(1 - \gamma I(t) \delta + o(\delta)\)</span></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="the-eulers-method" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="the-eulers-method">The Euler’s method</h2>
<ul>
<li>When referring the counting and its corresponding probability in <a href="#tbl-stochproc" class="quarto-xref">Table&nbsp;1</a>, it is obvious that we can derive a continuous time Markov chain (CTMC) for the SIR model:</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
  \pr\big[N_{SI}(t+\delta)&amp;\equals N_{SI}(t)+1\big] &amp;\equals&amp; \beta \, S(t)\, I(t) / N\, \delta + o(\delta),
  \\
  \pr\big[N_{IR}(t+\delta)&amp;\equals N_{IR}(t)+1\big] &amp;\equals&amp; \gamma \, I(t) \delta + o(\delta).
\end{aligned}
\]</span></p>
<ul>
<li>For <span class="math inline">\(k=1,2,...\)</span>, by discretizing this CTMC with small time step <span class="math inline">\(\delta\)</span>, we can derive a numerical solution with the state variables <span class="math inline">\(\tilde S(k\delta)\)</span>, <span class="math inline">\(\tilde I(k\delta)\)</span>, <span class="math inline">\(\tilde R(k\delta)\)</span>:</li>
</ul>
<p><span class="math display">\[\begin{array}{lcl}
        \tilde S(k\delta)&amp;=&amp; S(0) - \tilde N_{SI}(k\delta) \\
        \tilde I(k\delta)&amp;=&amp; I(0) + \tilde N_{SI}(k\delta) - \tilde N_{IR}(k\delta) \\
        \tilde R(k\delta) &amp;=&amp; R(0) + \tilde N_{IR}(k\delta)
\end{array}\]</span></p>
<ul>
<li><span class="math inline">\(\tilde N_{SI}(t)\)</span> and <span class="math inline">\(\tilde N_{IR}(t)\)</span>: the numerical solutions for <span class="math inline">\(N_{SI}(t)\)</span> and <span class="math inline">\(N_{IR}(t)\)</span></li>
</ul>
<ul>
<li><p>Let current <span class="math inline">\(t=k\delta\)</span>, consider the small time interval <span class="math inline">\(t\le \tau \le t+\delta\)</span>.</p></li>
<li><p>Assume that the gradients <span class="math inline">\(\deriv{N_{SI}}{t} = \mu_{SI}(t)\,S(t)\)</span> and <span class="math inline">\(\deriv{N_{IR}}{t} = \mu_{IR}\,I(t)\)</span> are approximately constant</p></li>
<li><p>We can have <span class="math inline">\(\tilde N_{SI}(t+\delta)\)</span> and <span class="math inline">\(\tilde N_{IR}(t+\delta)\)</span> as:</p></li>
</ul>
<p><span class="math display">\[
\begin{array}{lcl}
        \tilde N_{SI}(t+ \delta) &amp;=&amp; \tilde N_{SI}(t) + \delta\,\beta\, S(t)\,I(t)\,/ N \\
        \tilde N_{IR}(t + \delta) &amp;=&amp; \tilde N_{IR}(t) + \delta\,\gamma\,I(t) \\
\end{array}
\]</span></p>
<p>Now we can include stochastic variation in the Euler’s method.</p>
<ul>
<li>Recall the SDE:</li>
</ul>
<p><span class="math display">\[
  \deriv{X}{t} = h(X)+\sigma\,\deriv{B}{t}
\]</span></p>
<p>where <span class="math inline">\(\{B(t)\}\)</span> is Brownian motion and so <span class="math inline">\(dB/dt\)</span> is Brownian noise.</p>
<ul>
<li>An Euler approximation <span class="math inline">\(\tilde X(t)\)</span> within the small time interval <span class="math inline">\([t,t+\delta]\)</span> and <span class="math inline">\(t=k\delta\)</span> for <span class="math inline">\(k=0,1,2,\dots\)</span> is <span class="math display">\[
\tilde{X}\big( \,t + \delta\,\big) = \tilde{X}(t) + \delta\, h\big(\, \tilde{X}(t)\,\big) + \sigma \sqrt{\delta} \, Z_k
\]</span></li>
</ul>
<p>where <span class="math inline">\(Z_1,Z_2,\dots\)</span> are independent standard normal random variables, i.e., <span class="math inline">\(Z_k\sim \dist{Normal}{0,1}\)</span>.</p>
<ul>
<li>Although SDEs are often considered an advanced topic in probability, the Euler approximation doesn’t demand much more than familiarity with the normal distribution.</li>
</ul>
<p>Now we can consider applying the Euler’s method for a stochastic SIR model:</p>
<ul>
<li>A binomial approximation with exponential transition probabilities. <!-- $$ \tilde N_{SI}(t+\delta)= \tilde N_{SI}(t) + \mathrm{Binomial}\big[\tilde S(t),1-\exp\big\{-\mu_{SI}\big(\tilde I(t)\big) \delta\big\}\big],$$ --></li>
</ul>
<p><span class="math display">\[
\begin{aligned}
        \tilde N_{SI}(t+ \delta) &amp;= \tilde N_{SI}(t) + \mathrm{Binomial}\big[\tilde S(t),1-\exp\big\{-\beta\,\tilde I(t)/ N\,\delta\big\}\big], \\
        \tilde N_{IR}(t + \delta) &amp;= \tilde N_{IR}(t) + \mathrm{Binomial}\big[\tilde I(t), 1-\exp\big\{-\delta\,\gamma\big\}\big], \\
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\mathrm{Binomial}(n,p)\)</span> is a binomial random variable with mean <span class="math inline">\(np\)</span> and variance <span class="math inline">\(np(1-p)\)</span>. Here, <span class="math inline">\(p=1-\exp\big\{-\beta\,\tilde I(t)/ N\,\delta\big\}\)</span> and <span class="math inline">\(p=1-\exp\big\{-\delta\,\gamma\big\}\)</span>, respectively.</p>
<p>The following are two other ways for a stochastic SIR model with the Euler’s approximation, what they are not as good as the previous one?</p>
<ol type="1">
<li><p>A Poisson approximation. <span class="math display">\[\tilde N_{SI}(t+\delta)= \tilde N_{SI}(t) + \mathrm{Poisson}\big[\beta\,\tilde S(t)\,\tilde I(t) / N\, \delta\big],\]</span> where <span class="math inline">\(\mathrm{Poisson}(\mu)\)</span> is a Poisson random variable with mean <span class="math inline">\(\mu=\beta\,\tilde S(t)\,\tilde I(t) / N\, \delta\)</span>.</p></li>
<li><p>A binomial approximation, <span class="math display">\[\tilde N_{SI}(t+\delta) = \tilde N_{SI}(t) + \mathrm{Binomial}\big[\tilde S(t),\beta\,\tilde I(t) / N \, \delta\big].\]</span></p></li>
</ol>
</section>
<section id="the-gillespie-method" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="the-gillespie-method">The Gillespie method</h2>
<ul>
<li><p>Numerical methods, such as the Euler’s method, are approximations to the process by discretizing time using small time step <span class="math inline">\(\delta\)</span></p></li>
<li><p>However, the Gillespie method is the exact <strong>Stochastic Simulation Method</strong>, which leverages the Markov Property as well.</p></li>
<li><p>In <a href="#tbl-stochproc" class="quarto-xref">Table&nbsp;1</a>, by consider the reactions and the probabilities, we can derive the Gillespie algorithm for the stochastic SIR model.</p></li>
</ul>
<p>With initialization, <span class="math inline">\(S(0)\)</span>, <span class="math inline">\(I(0)\)</span>, and <span class="math inline">\(R(0)\)</span>, at current time <span class="math inline">\(t\)</span>:</p>
<ol type="1">
<li><p>Compute the total event rates: <span class="math inline">\(\lambda_1 = \beta\,S(t)\,I(t)/N, \lambda_2 = \gamma\,I(t), \lambda = \lambda_1 + \lambda_2\)</span></p></li>
<li><p>Compute the waiting time <span class="math inline">\(\Delta t \sim \mathrm{Exponential}(\lambda)\)</span></p></li>
<li><p>Select the reactions by sampling from probabilities <span class="math inline">\(\left(\frac{\lambda_1}{\lambda}, \frac{\lambda_2}{\lambda}\right)\)</span></p></li>
<li><p>Update the states from the selected reaction and update the time <span class="math inline">\(t\to t+\Delta t\)</span></p></li>
<li><p>Repeat 1-4 till the end of the simulation time</p></li>
</ol>
<p>Even though the Gillespie is an exact stochastic simulation method, it has limitations such as:</p>
<ul>
<li><p>Computational Intensity: For complex systems with many reactions, the Gillespie method can become computationally expensive.</p></li>
<li><p>Rare Events: For systems where some reactions are very rare, a large number of simulation steps may be needed to capture these events, making the method slow.</p></li>
</ul>
</section>
<section id="euler-vs.-gillespie" class="level2">
<h2 class="anchored" data-anchor-id="euler-vs.-gillespie">Euler vs.&nbsp;Gillespie</h2>
<ul>
<li>Why and When would you prefer an implementation of Gillespie’s algorithm to an Euler solution?</li>
</ul>
<p><a href="./exercises.html#exercise-euler-versus-gillespie">Worked solution to the Exercise</a></p>
<ul>
<li>Numerically, Gillespie’s algorithm is often approximated using so-called <a href="https://en.wikipedia.org/wiki/Tau-leaping">tau-leaping</a> methods. These are closely related to Euler’s approach. In this context, the Euler method has sometimes been called tau-leaping.</li>
</ul>
<!-- ## Simple counting processes -->
<!-- -   A *simple counting process* is one which cannot count more than one event at a time. -->
<!-- -   Technically, the SIR Markov chain model we have written is simple. -->
<!-- -   One may want to model the extra randomness resulting from multiple simultaneous events: someone sneezing in a bus; large gatherings at football matches; etc. This extra randomness may even be critical to match the variability in data. -->
<!-- -   Later in the course, we may see situations where this extra randomness plays an important role. Setting up the model using counting processes, as we have done here, turns out to be useful for this. -->
<!-- ## Continuous-time Markov chain interpretation {.allowframebreaks} -->
<!-- -   Continuous-time Markov chains are the basic tool for building discrete population epidemic models. -->
<!-- -   The **Markov property** lets us specify a model by the *transition probabilities* on small intervals (together with the initial conditions). For the SIR model, we have -->
<!-- \begin{equation*} -->
<!--       \begin{aligned} -->
<!--         \pr\big[N_{SI}(t+\delta)&= N_{SI}(t)+1\big] &=& \phantom{1-}\mu_{SI}(t)\,S(t)\,\delta + o(\delta) -->
<!--         \\ -->
<!--         \pr\big[N_{SI}(t+\delta)&= N_{SI}(t)\big] &=& 1-\mu_{SI}(t)\,S(t)\,\delta + o(\delta) -->
<!--         \\ -->
<!--         \pr\big[N_{IR}(t+\delta)&= N_{IR}(t)+1\big] &=& \phantom{1-}\mu_{IR}\,I(t)\,\delta + o(\delta) -->
<!--         \\ -->
<!--         \pr\big[N_{IR}(t+\delta)&= N_{IR}(t)\big] &=& 1-\mu_{IR}(t)\,I(t)\,\delta + o(\delta) -->
<!--       \end{aligned} -->
<!--     \end{equation*} -->
<!-- -   Here, we are using *little o notation* and we write $h(\delta)=o(\delta)$ to mean $\lim_{\delta\to 0} \frac{h(\delta)}{\delta} = 0$. -->
<!-- \framebreak -->
<!-- - What is the link between little $o$ notation and the derivative?  -->
<!-- - Explain why $$f(x+\delta)=f(x)+ \delta g(x) + o(\delta)$$ is the same statement as $$ \frac{df}{dx} = g(x).$$  -->
<!-- - What considerations might help you choose which of these notations to use? -->
<!-- \vfill -->
<!-- [Worked solution to the Exercise](./exercises.html#exercise-little-o-notation) -->
<!-- # Euler's method -->
<!-- # Numerical solution of deterministic dynamics -->
<!-- ## Euler's method for ordinary differential equations {.allowframebreaks} -->
<!-- -   Euler (1707--1783) wanted a numeric solution of an ordinary differential equation (ODE) $dx/dt = h(x)$ with an initial condition $x(0)$. -->
<!-- -   He supposed this ODE has some true solution $x(t)$ which could not be worked out analytically. He wanted an approximation $\tilde{x}(t)$ of $x(t)$. -->
<!-- -   He initialized the numerical solution at the known starting value, $$\tilde x(0)=x(0).$$ -->
<!-- -   For $k=1,2,\dots$, he supposed that the gradient $dx/dt$ is approximately constant over the small time interval $k\delta\le t\le (k+1)\delta$. Therefore, he defined $$\tilde x\big( \,(k+1)\delta\,\big) = \tilde x( k\delta) + \delta \, h\big(\, \tilde x(k\delta)\,\big).$$ -->
<!-- -   This only defines $\tilde x(t)$ when $t$ is a multiple of $\delta$, but suppose $\tilde x(t)$ is constant between these discrete times. -->
<!-- -   We now have a numerical scheme, stepping forwards in time increments of size $\delta$, that can be readily evaluated by computer. -->
<!-- ## Euler's method versus other numerical methods {.allowframebreaks} -->
<!-- -   Mathematical analysis of Euler's method says that, as long as the function $h(x)$ is not too exotic, then $x(t)$ is well approximated by $\tilde x(t)$ when the discretization time-step, $\delta$, is sufficiently small. -->
<!-- -   Euler's method is not the only numerical scheme to solve ODEs. More advanced schemes have better convergence properties, meaning that the numerical approximation is closer to $x(t)$. However, there are 3 reasons we choose to lean heavily on Euler's method: -->
<!-- 1.  Euler's method is the simplest (cf.\ the KISS principle). -->
<!-- 2.  Euler's method extends naturally to stochastic models, both continuous-time Markov chains models and stochastic differential equation (SDE) models. -->
<!-- 3.  Close approximation of the numerical solutions to a continuous-time model is less important than it may at first appear, a topic to be discussed. -->
<!-- ## Continuous-time models and discretized approximations -->
<!-- -   In some physical and engineering situations, a system follows an ODE model closely. For example, Newton's laws provide a very good approximation to the motions of celestial bodies. -->
<!-- -   In many biological situations, ODE models only become close mathematical approximations to reality at reasonably large scale. On small temporal scales, models cannot usually capture the full scope of biological variation and biological complexity. -->
<!-- -   If we are going to expect substantial error in using $x(t)$ to model a biological system, maybe the numerical solution $\tilde x(t)$ represents the system being modeled as well as $x(t)$ does. -->
<!-- -   If our model fitting, model investigation, and final conclusions are all based on our numerical solution $\tilde x(t)$ (i.e., we are sticking entirely to simulation-based methods) then we are most immediately concerned with how well $\tilde x(t)$ describes the system of interest. $\tilde x(t)$ becomes more important than the original model, $x(t)$. -->
<!-- ## Numerical solutions as scientific models -->
<!-- -   It is important that a scientist fully describe the numerical model $\tilde x(t)$. Arguably, the main purpose of the original model $x(t)$ is to give a succinct description of how $\tilde x(t)$ was constructed. -->
<!-- -   All numerical methods are, ultimately, discretizations. Epidemiologically, setting $\delta$ to be a day, or an hour, can be quite different from setting $\delta$ to be two weeks or a month. For continuous-time modeling, we still require that $\delta$ is small compared to the timescale of the process being modeled, so the choice of $\delta$ should not play an explicit role in the interpretation of the model. -->
<!-- -   Putting more emphasis on the scientific role of the numerical solution itself reminds you that the numerical solution has to do more than approximate a target model in some asymptotic sense: the numerical solution should be a sensible model in its own right. -->
<!-- ## Euler's method for a discrete SIR model {.allowframebreaks} -->
<!-- -   Recall the simple continuous-time Markov chain interpretation of the SIR model without demography: \begin{equation*} -->
<!--      \begin{aligned} -->
<!--        \pr\big[N_{SI}(t+\delta)&\equals N_{SI}(t)+1\big] &\equals& \mu_{SI}(t) \, S(t) \delta + o(\delta), -->
<!--        \\ -->
<!--        \pr\big[N_{IR}(t+\delta)&\equals N_{IR}(t)+1\big] &\equals& \mu_{IR} \, I(t) \delta + o(\delta). -->
<!--      \end{aligned} -->
<!--         \end{equation*} -->
<!-- -   We want a numerical solution with state variables $\tilde S(k\delta)$, $\tilde I(k\delta)$, $\tilde R(k\delta)$. -->
<!-- -   The counting processes for the flows between compartments are $\tilde N_{SI}(t)$ and $\tilde N_{IR}(t)$. The counting processes are related to the numbers of individuals in the compartments by the same flow equations we had before: $$\begin{array}{lcl} -->
<!--         \tilde S(k\delta)&=& S(0) - \tilde N_{SI}(k\delta) -->
<!--         \\ -->
<!--         \tilde I(k\delta)&=& I(0) + \tilde N_{SI}(k\delta) - \tilde N_{IR}(k\delta) -->
<!--         \\ -->
<!--         \tilde R(k\delta) &=& R(0) + \tilde N_{IR}(k\delta) -->
<!--       \end{array}$$ -->
<!-- -   We focus on a numerical solution to $N_{SI}(t)$, since the same methods can also be applied to $N_{IR}(t)$. -->
<!-- # Numerical solution of stochastic dynamics -->
<!-- ## Three different stochastic Euler solutions -->
<!-- \vspace{-3mm} -->
<!-- 1.  A Poisson approximation. $$\tilde N_{SI}(t+\delta)= \tilde N_{SI}(t) + \mathrm{Poisson}\big[\mu_{SI}\big(\tilde I(t)\big) \, \tilde S(t) \,\delta\big],$$ where $\mathrm{Poisson}(\mu)$ is a Poisson random variable with mean $\mu$ and $$\mu_{SI}\big(\tilde I(t)\big) = \beta\, \tilde I(t).$$ -->
<!-- 2.  A binomial approximation, $$\tilde N_{SI}(t+\delta) = \tilde N_{SI}(t) + \mathrm{Binomial}\big[\tilde S(t),\mu_{SI}\big(\tilde I(t)\big) \, \delta\big],$$ where $\mathrm{Binomial}(n,p)$ is a binomial random variable with mean $np$ and variance $np(1-p)$. Here, $p=\mu_{SI}\big(\tilde I(t)\big) \, \delta$. -->
<!-- 3.  A binomial approximation with exponential transition probabilities. $$ \tilde N_{SI}(t+\delta)= \tilde N_{SI}(t) + \mathrm{Binomial}\big[\tilde S(t),1-\exp\big\{-\mu_{SI}\big(\tilde I(t)\big) \delta\big\}\big].$$ -->
<!-- \hrulefill -->
<!-- Analytically, it is usually easiest to reason using (1) or (2). Practically, it is usually preferable to work with (3). -->
<!-- ## Compartment models as stochastic differential equations -->
<!-- -   The Euler method extends naturally to stochastic differential equations (SDEs). -->
<!-- -   A natural way to add stochastic variation to an ODE $dx/dt=h(x)$ is \begin{equation*} -->
<!--      \deriv{X}{t} = h(X)+\sigma\,\deriv{B}{t} -->
<!--         \end{equation*} where $\{B(t)\}$ is Brownian motion and so $dB/dt$ is Brownian noise. -->
<!-- -   An Euler approximation $\tilde X(t)$ is \begin{equation*} -->
<!--      \tilde{X}\big( \,(k+1)\delta\,\big) = \tilde{X}( k\delta) + \delta\, h\big(\, \tilde{X}(k\delta)\,\big) + \sigma \sqrt{\delta} \, Z_k -->
<!--         \end{equation*} where $Z_1,Z_2,\dots$ are independent standard normal random variables, i.e., $Z_k\sim \dist{Normal}{0,1}$. -->
<!-- -   Although SDEs are often considered an advanced topic in probability, the Euler approximation doesn't demand much more than familiarity with the normal distribution. -->
<!-- ## Euler's method vs Gillespie's algorithm -->
<!-- A widely used, exact simulation method for continuous time Markov chains is [Gillespie's algorithm](https://en.wikipedia.org/wiki/Gillespie_algorithm). We do not put much emphasis on Gillespie's algorithm here. Why? When would you prefer an implementation of Gillespie's algorithm to an Euler solution? -->
<!-- \vspace{3mm} -->
<!-- [Worked solution to the Exercise](./exercises.html#exercise-euler-versus-gillespie) -->
<!-- \vspace{3mm} -->
<!-- Numerically, Gillespie's algorithm is often approximated using so-called [tau-leaping](https://en.wikipedia.org/wiki/Tau-leaping) methods. These are closely related to Euler's approach. In this context, the Euler method has sometimes been called tau-leaping. -->
</section>
<section id="compartment-models-in-pomp-the-consett-measles-outbreaks" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="compartment-models-in-pomp-the-consett-measles-outbreaks">Compartment models in <code>pomp</code>: The Consett Measles outbreaks</h2>
<!-- # A basic pomp model for measles -->
<!-- ## The Consett measles outbreak {.allowframebreaks} -->
<p>Let’s look at outbreak of measles in the town of Consett in England in 1948:</p>
<ul>
<li><p>the town had population of 38820,</p></li>
<li><p>with 737 births over the course of the year.</p></li>
</ul>
<!-- As an example that we can probe in some depth, let's look at outbreak of measles that occurred in the small town of Consett in England in 1948. -->
<!-- The town had population of 38820, with 737 births over the course of the year. -->
<!-- \framebreak -->
<!-- We download the data and examine them: -->
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"Measles_Consett_1948.csv"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(week,<span class="at">reports=</span>cases) <span class="ot">-&gt;</span> meas</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>meas <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="at">n=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> week reports
    1       0
    2       0
    3       2</code></pre>
</div>
</div>
<div class="columns">
<div class="column" style="width:30%;">

</div><div class="column" style="width:70%;">
<ul>
<li><p><code>week</code>: time, indicates that the data are counted weekly</p></li>
<li><p><code>reports</code> variable: incidence, counts the number of reports of new measles cases each week</p></li>
</ul>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/meas-data2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="1800"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-sir-as-a-pomp-model-for-measles" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="the-sir-as-a-pomp-model-for-measles">The SIR as a POMP model for measles</h2>
<div class="columns">
<div class="column" style="width:30%;">

</div><div class="column" style="width:70%;">
<ul>
<li><p>The <strong>unobserved states</strong>: <span class="math inline">\(S(t)\)</span>, <span class="math inline">\(I(t)\)</span>, <span class="math inline">\(R(t)\)</span>, the numbers of individuals in the S, I, and R compartments, respectively.</p></li>
<li><p>The constant population size: <span class="math inline">\(N=S(t)+I(t)+R(t)\)</span>, as fixed at the known population size of 38,000.</p></li>
<li><p><strong>Flows</strong> move from one compartment to another over any particular time interval are modeled as <em>stochastic processes</em>.</p></li>
<li><p><strong>Demographic stochasticity</strong>: each individual in a compartment at any given time faces the same risk of exiting the compartment; the unavoidable randomness that arises from chance events occurring in a discrete and finite population.</p></li>
</ul>
</div>
</div>
<p>Recall the application of the Euler’s method to a stochastic SIR model.</p>
<ul>
<li><span class="math inline">\(\Delta N_{SI}\)</span> and <span class="math inline">\(\Delta N_{IR}\)</span>: the flows from S to I and from I to R over interval <span class="math inline">\(\Delta t\)</span>, respectively:</li>
</ul>
<p><span class="math display">\[
\begin{aligned}
    \Delta N_{SI} &amp;\sim \mathrm{Binomial}\left(S, 1-e^{-\beta\frac{I}{N}\Delta t}\right),\\
    \Delta N_{IR} &amp;\sim \mathrm{Binomial}\left(I, 1-e^{-\gamma\Delta t}\right).
\end{aligned}
\]</span></p>
<ul>
<li>Implement the dynamics in <code>pomp</code> as an R function:</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>sir_stoch <span class="ot">&lt;-</span> <span class="cf">function</span> (S, I, R, N, Beta, Gamma, delta.t, ...) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  dN_SI <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>,<span class="at">size=</span>S,<span class="at">prob=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>Beta<span class="sc">*</span>I<span class="sc">/</span>N<span class="sc">*</span>delta.t))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  dN_IR <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>,<span class="at">size=</span>I,<span class="at">prob=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>Gamma<span class="sc">*</span>delta.t))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> S <span class="sc">-</span> dN_SI</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  I <span class="ot">&lt;-</span> I <span class="sc">+</span> dN_SI <span class="sc">-</span> dN_IR</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> R <span class="sc">+</span> dN_IR</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">S =</span> S, <span class="at">I =</span> I, <span class="at">R =</span> R)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Note that, for a deterministic SIR model:</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dN_SI <span class="ot">&lt;-</span> Beta<span class="sc">*</span>S<span class="sc">*</span>I<span class="sc">/</span>N<span class="sc">*</span>delta.t</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>dN_IR <span class="ot">&lt;-</span> Gamma<span class="sc">*</span>I<span class="sc">*</span>delta.t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can implement the initialization function with the following assumptions:</p>
<ul>
<li><p>Assume the dynamics starts at week 0, <span class="math inline">\(t0=0\)</span>.</p></li>
<li><p>At <span class="math inline">\(t0\)</span>, assume the initial number of infection is 1, that is <span class="math inline">\(I=1\)</span>.</p></li>
<li><p>The initial number of susceptible is unknown, so we’ll treat this fraction, <span class="math inline">\(\eta\)</span>, as a parameter to be estimated.</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>sir_rinit <span class="ot">&lt;-</span> <span class="cf">function</span> (N, Eta, ...) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">S =</span> <span class="fu">round</span>(N<span class="sc">*</span>Eta), <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="fu">round</span>(N<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Eta)))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the initialization function <code>sir_rinit</code> and the process function <code>sir_stoch</code>, we can build a <code>pomp</code> object with these two components and the data:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pomp)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>meas <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pomp</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">times=</span><span class="st">"week"</span>,<span class="at">t0=</span><span class="dv">0</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">rprocess=</span><span class="fu">euler</span>(sir_stoch,<span class="at">delta.t=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">7</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">rinit=</span>sir_rinit</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> measSIR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Question: what do <code>times="week"</code> and <code>delta.t=1/7</code> indicate?</li>
</ul>
<ul>
<li><p>Assume the <strong>observations</strong>, the <code>reports</code>, result from a process by which new infections are diagnosed in a hospital and reported with probability <span class="math inline">\(\rho\)</span>.</p></li>
<li><p>The diagnosed infections are immediately hospitalized, therefore, they have, presumably, a much lower transmission rate; let’s assume each <em>week’s</em> reports as being related to the number of individuals who have moved from I to R over the course of that week.</p></li>
<li><p>We then define a new variable, <span class="math inline">\(H\)</span>, that tracks these daily counts.</p></li>
</ul>
<p>We now can modify the R functions to incorporate the new variable <span class="math inline">\(H\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sir_stoch <span class="ot">&lt;-</span> <span class="cf">function</span> (S, I, R, N, Beta, Gamma, delta.t, H, ...) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  dN_SI <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>,<span class="at">size=</span>S,<span class="at">prob=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>Beta<span class="sc">*</span>I<span class="sc">/</span>N<span class="sc">*</span>delta.t))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  dN_IR <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n=</span><span class="dv">1</span>,<span class="at">size=</span>I,<span class="at">prob=</span><span class="dv">1</span><span class="sc">-</span><span class="fu">exp</span>(<span class="sc">-</span>Gamma<span class="sc">*</span>delta.t))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  S <span class="ot">&lt;-</span> S <span class="sc">-</span> dN_SI</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  I <span class="ot">&lt;-</span> I <span class="sc">+</span> dN_SI <span class="sc">-</span> dN_IR</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  R <span class="ot">&lt;-</span> R <span class="sc">+</span> dN_IR</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  H <span class="ot">&lt;-</span> H <span class="sc">+</span> dN_IR</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">S =</span> S, <span class="at">I =</span> I, <span class="at">R =</span> R, <span class="at">H =</span> H)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>sir_rinit <span class="ot">&lt;-</span> <span class="cf">function</span> (N, Eta, ...) {</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">S =</span> <span class="fu">round</span>(N<span class="sc">*</span>Eta), <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="fu">round</span>(N<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>Eta)), <span class="at">H =</span> <span class="dv">0</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that, we are so far accounting for the <em>flows</em> between compartments by days, while the <code>reports</code> are weekly cases. Since we want <span class="math inline">\(H\)</span> to tally only the incidence over the week, we’ll need to reset it to zero at the beginning of each week. Thus, in <code>pomp</code> terminology, <span class="math inline">\(H\)</span> is an <strong>accumulator variable</strong>. We accomplish this using the <code>accumvars</code> argument to <code>pomp</code> when build the object:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pomp</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">rprocess=</span><span class="fu">euler</span>(sir_stoch,<span class="at">delta.t=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">7</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rinit=</span>sir_rinit, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">accumvars=</span><span class="st">"H"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> measSIR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Question: what does that mean by running a <code>pomp</code> function with the <code>pomp</code> object <code>measSIR</code>?</li>
</ul>
<p>Last but not least, we need to define a <strong>measurement model</strong> to relate the <strong>observations</strong>, <code>reports</code>, to the <strong>unobserved</strong> accumulative state, <span class="math inline">\(H\)</span>.</p>
<ul>
<li>We will model the data by a negative binomial variable, <span class="math display">\[\mathrm{reports}_t \sim \dist{NegBin}{\rho\,H(t),k}.\]</span> with mean <span class="math inline">\(\rho\,H(t)\)</span> and variance <span class="math inline">\(\rho H(t)+ \big(\rho H(t)\big)^2/k\)</span>. The binomial distribution does not have a separate variance parameter.</li>
</ul>
<ul>
<li>To include the observations in the model, we must write either a <code>dmeasure</code> or an <code>rmeasure</code> component, or both:</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sir_dmeas <span class="ot">&lt;-</span> <span class="cf">function</span> (reports, H, Rho, k, log, ...) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnbinom</span>(<span class="at">x=</span>reports, <span class="at">size=</span>k, <span class="at">mu=</span>Rho<span class="sc">*</span>H, <span class="at">log=</span>log)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sir_rmeas <span class="ot">&lt;-</span> <span class="cf">function</span> (H, Rho, k, ...) {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="at">reports=</span><span class="fu">rnbinom</span>(<span class="at">n=</span><span class="dv">1</span>, <span class="at">size=</span>k, <span class="at">mu=</span>Rho<span class="sc">*</span>H))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Eventually, we can add these two components to the previous <code>measSIR</code> object to update the <code>dmeasure</code> and <code>rmeasure</code> arguments:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pomp</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmeasure=</span>sir_rmeas,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">dmeasure=</span>sir_dmeas</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> measSIR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- - Exercise: test the `measSIR` object and simulate with pre-defined parameters using the `simulate` function. -->
<!-- ```{r test_R_pomp,eval=FALSE} -->
<!-- measSIR |> -->
<!--   simulate(params=c(Beta=8,Gamma=0.5,Rho=0.5,k=10,N=38000,Eta=1/10)) -->
<!-- ``` -->
<!-- -   These are incidence data: The `reports` variable counts the number of reports of new measles cases each week. -->
<!-- -   Let us model the outbreak using the simple SIR model. -->
<!-- -   Our tasks will be, first, to estimate the parameters of the SIR and, second, to decide whether or not the SIR model is an adequate description of these data. -->
<!-- -   The rate at which individuals move from S to I is the *force of infection*, $\mu_{SI}=\beta\,I/N$, while that at which individuals move into the R class is $\mu_{IR}$. -->
<!-- ## Framing the SIR as a POMP model -->
<!-- -   The unobserved state variables, in this case, are the numbers of individuals, $S(t)$, $I(t)$, $R(t)$ in the S, I, and R compartments, respectively. -->
<!-- -   It's reasonable in this case to view the population size $N=S(t)+I(t)+R(t)$, as fixed at the known population size of 38,000. -->
<!-- -   The numbers that actually move from one compartment to another over any particular time interval are modeled as stochastic processes. -->
<!-- -   In this case, we'll assume that the stochasticity is purely demographic, i.e., that each individual in a compartment at any given time faces the same risk of exiting the compartment. -->
<!-- -   *Demographic stochasticity* is the unavoidable randomness that arises from chance events occurring in a discrete and finite population. -->
<!-- ## Implementing the SIR model in pomp {.allowframebreaks} -->
<!-- -   To implement the model in pomp, the first thing we need is a stochastic simulator for the unobserved state process. -->
<!-- -   We follow method 3 above, modeling the number, $\Delta{N_{SI}}$, moving from S to I over interval $\Delta{t}$ as $$\Delta{N_{SI}} \sim \dist{Binomial}{S,1-e^{-\beta\,\frac{I}{N}\,\Delta{t}}},$$ and the number moving from I to R as $$\Delta{N_{IR}} \sim \dist{Binomial}{I,1-e^{-\mu_{IR}\,\Delta{t}}}.$$ -->
<!-- ```{r rproc1R} -->
<!--     sir_stoch <- function (S, I, R, N, Beta, mu_IR, delta.t, ...) -->
<!--     { -->
<!--       dN_SI <- rbinom(n=1,size=S,prob=1-exp(-Beta*I/N*delta.t)) -->
<!--       dN_IR <- rbinom(n=1,size=I,prob=1-exp(-mu_IR*delta.t)) -->
<!--       S <- S - dN_SI -->
<!--       I <- I + dN_SI - dN_IR -->
<!--       R <- R + dN_IR -->
<!--       c(S = S, I = I, R = R) -->
<!--     } -->
<!-- ``` -->
<!-- -   At day zero, we'll assume that $I=1$ but we don't know how many people are susceptible, so we'll treat this fraction, $\eta$, as a parameter to be estimated. -->
<!-- ```{r init1R} -->
<!--     sir_rinit <- function (N, eta, ...) { -->
<!--       c(S = round(N*eta), I = 1, R = round(N*(1-eta))) -->
<!--     } -->
<!-- ``` -->
<!-- -   We fold these basic model components, with the data, into a `pomp` object thus: -->
<!-- ```{r pomp1R} -->
<!--     library(pomp) -->
<!--     meas |> -->
<!--       pomp(times="week",t0=0, -->
<!--         rprocess=euler(sir_stoch,delta.t=1/7), -->
<!--         rinit=sir_rinit -->
<!--       ) -> measSIR -->
<!-- ``` -->
<!-- -   Now assume the case reports result from a process by which new infections are diagnosed and reported with probability $\rho$, which we can think of as the probability that a child's parents take the child to the doctor, who recognizes measles and reports it to the authorities. -->
<!-- -   Measles symptoms tend to be quite recognizable, and children with measles tend to be confined to bed. Therefore diagnosed cases have, presumably, a much lower transmission rate. Accordingly, let's treat each week's `reports` as being related to the number of individuals who have moved from I to R over the course of that week. -->
<!-- -   We need a variable to track these daily counts. We modify our rprocess function above, adding a variable $H$ to tally the true incidence. -->
<!-- ```{r rproc2R} -->
<!--     sir_stoch <- function (S, I, R, N, Beta, mu_IR, delta.t, -->
<!--       H, ...) { -->
<!--       dN_SI <- rbinom(n=1,size=S,prob=1-exp(-Beta*I/N*delta.t)) -->
<!--       dN_IR <- rbinom(n=1,size=I,prob=1-exp(-mu_IR*delta.t)) -->
<!--       S <- S - dN_SI -->
<!--       I <- I + dN_SI - dN_IR -->
<!--       R <- R + dN_IR -->
<!--       H <- H + dN_IR -->
<!--       c(S = S, I = I, R = R, H = H) -->
<!--     } -->
<!--     sir_rinit <- function (N, eta, ...) { -->
<!--       c(S = round(N*eta), I = 1, R = round(N*(1-eta)), H = 0) -->
<!--     } -->
<!-- ``` -->
<!-- -   In pomp terminology, $H$ is an *accumulator variable*. Since we want $H$ to tally only the incidence over the week, we'll need to reset it to zero at the beginning of each week. We accomplish this using the `accumvars` argument to `pomp`: -->
<!-- ```{r zero1R} -->
<!--     measSIR |> -->
<!--       pomp( -->
<!--         rprocess=euler(sir_stoch,delta.t=1/7), -->
<!--         rinit=sir_rinit, accumvars="H" -->
<!--       ) -> measSIR -->
<!-- ``` -->
<!-- -   Now, we'll model the data by a negative binomial variable, \begin{equation*} -->
<!--      \mathrm{reports}_t \sim \dist{NegBin}{\rho\,H(t),k}. -->
<!--         \end{equation*} with mean $\rho\,H(t)$ and variance $\rho H(t)+ \big(\rho H(t)\big)^2/k$. The binomial distribution does not have a separate variance parameter. -->
<!-- -   Now, to include the observations in the model, we must write either a `dmeasure` or an `rmeasure` component, or both: -->
<!-- ```{r meas-modelR} -->
<!--     sir_dmeas <- function (reports, H, rho, k, log, ...) { -->
<!--       dnbinom(x=reports, size=k, mu=rho*H, log=log) -->
<!--     } -->
<!--     sir_rmeas <- function (H, rho, k, ...) { -->
<!--       c(reports=rnbinom(n=1, size=k, mu=rho*H)) -->
<!--     } -->
<!-- ``` -->
<!-- -   We then put these into our `pomp` object: -->
<!-- ```{r add-meas-modelR} -->
<!--     measSIR |> -->
<!--       pomp( -->
<!--         rmeasure=sir_rmeas, -->
<!--         dmeasure=sir_dmeas -->
<!--       ) -> measSIR -->
<!-- ``` -->
<!-- ```{r test_R_pomp,include=FALSE,purl=FALSE} -->
<!--     measSIR |> -->
<!--       simulate(params=c(Beta=8,mu_IR=0.5,rho=0.5,k=10,N=38000,eta=1/10)) -->
<!-- ``` -->
</section>
</section>
<section id="c-snippets" class="level1">
<h1>C snippets</h1>
<section id="specifying-model-components-using-c-snippets" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="specifying-model-components-using-c-snippets">Specifying model components using C snippets</h2>
<ul>
<li><p>Although we can always specify basic model components using <code>R</code> functions, as above, we`ll typically want the computational speed-up that we can obtain only by using compiled native code.</p></li>
<li><p>pomp provides a facility for doing so with ease, using <em>C snippets</em>.</p></li>
<li><p>C snippets are small pieces of C code used to specify basic model components.</p></li>
</ul>
<ul>
<li>For example, a C snippet encoding the rprocess for an <code>sir</code> model is as follows.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sir_stoch <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_SI = rbinom(S,1-exp(-Beta*I/N*dt));</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_IR = rbinom(I,1-exp(-Gamma*dt));</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">  S -= dN_SI;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">  I += dN_SI - dN_IR;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">  R += dN_IR;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">  H += dN_IR;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Note:</strong></p>
<ul>
<li><p>It is necessary to define the data type for the real values <code>dN_SI</code> and <code>dN_IR</code> as <code>double</code>. The data type for states does not need to be defined at this stage and will be addressed later.</p></li>
<li><p><code>rbinom</code> is a built-in function used to generate random values from a binomial distribution. For additional built-in distributions in R, you can refer to <a href="https://github.com/atks/Rmath/blob/master/Rmath/Rmath.h">this Rmath.h document</a>.</p></li>
<li><p>Remember to add a semicolon (<code>;</code>) after each line to ensure proper syntax.</p></li>
<li><p>C snippets for the initializer and measurement model are:</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sir_rinit <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="st">  S = nearbyint(Eta*N);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="st">  I = 1;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="st">  R = nearbyint((1-Eta)*N);</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="st">  H = 0;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>sir_dmeas <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="st">  lik = dnbinom_mu(reports,k,Rho*H,give_log);</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>sir_rmeas <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="st">  reports = rnbinom_mu(k,Rho*H);</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>No need to define the type for likelihood <code>(lik)</code> here, as it is already predefined.</p></li>
<li><p><code>nearbyint</code> is a built-in function used to find the closest integer to a given value.</p></li>
<li><p><code>reports</code> is the variable name specified in your dataset.</p></li>
</ul>
<ul>
<li>A call to <code>pomp</code> replaces the basic model components with these, much faster, implementations:</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pomp</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">rprocess=</span><span class="fu">euler</span>(sir_stoch,<span class="at">delta.t=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">7</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rinit=</span>sir_rinit,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmeasure=</span>sir_rmeas,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">dmeasure=</span>sir_dmeas,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">accumvars=</span><span class="st">"H"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">statenames=</span><span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"I"</span>,<span class="st">"R"</span>,<span class="st">"H"</span>),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">paramnames=</span><span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Gamma"</span>,<span class="st">"N"</span>,<span class="st">"Eta"</span>,<span class="st">"Rho"</span>,<span class="st">"k"</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> measSIR_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<ul>
<li><p>Note that, when using C snippets, one has to tell pomp which of the variables referenced in the C snippets are state variables and which are parameters. This is accomplished using the <code>statenames</code> and <code>paramnames</code> arguments.</p></li>
<li><p>We can tell from the summary table that CSnippet is approximate 50 times faster than R.</p></li>
</ul>
</div><div class="column" style="width:50%;">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/CSnippet-compare-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="1200"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="choosing-parameters" class="level1">
<h1>Choosing parameters</h1>
<section id="guessing-plausible-parameter-values" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="guessing-plausible-parameter-values">Guessing plausible parameter values</h2>
<ul>
<li><p>To check the code is working properly, we simulate. This requires us to assign parameters. A little thought will get us some ballpark estimates.</p></li>
<li><p>Recall that <span class="math inline">\(\Rzero\)</span> is the expected number of secondary infections resulting from one primary infection introduced into a fully susceptible population. For an SIR infection, one has that <span class="math inline">\(\Rzero\approx\frac{L}{A}\)</span>, where <span class="math inline">\(L\)</span> is the lifespan of a host and <span class="math inline">\(A\)</span> is the mean age of infection. Analysis of age-stratified serology data establish that the mean age of infection for measles during this period was around 4–5yr <span class="citation" data-cites="Anderson1991">(<a href="#ref-Anderson1991" role="doc-biblioref">Anderson and May 1991</a>)</span>. Assuming a lifespan of 60–70yr, we have <span class="math inline">\(\Rzero\approx 15\)</span>.</p></li>
<li><p>The basic theory of SIR epidemics gives the final-size equation, <span class="math display">\[\Rzero = -\frac{\log{(1-f)}}{f},\]</span> where <span class="math inline">\(f\)</span> is the final size of the epidemic—the fraction of those susceptible at the beginning of the outbreak who ultimately become infected. For <span class="math inline">\(\Rzero&gt;5\)</span>, this equation predicts that <span class="math inline">\(f&gt;0.99\)</span>.</p></li>
<li><p>In the data, it looks like there were a total of <span class="math inline">\(521\)</span> infections.<br>
Assuming 50% reporting, we have that <span class="math inline">\(S_0\approx1042\)</span>, so that <span class="math inline">\(\eta=\frac{S_0}{N}\approx0.027\)</span>.</p></li>
<li><p>If the infectious period is roughly 2 weeks, then <span class="math inline">\(1/\mu_{IR} \approx 2~\text{wk}\)</span> and <span class="math inline">\(\beta = \mu_{IR}\,\Rzero \approx 7.5~\text{wk}^{-1}\)</span>.</p></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">params=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="fl">7.5</span>,<span class="at">Gamma=</span><span class="fl">0.5</span>,<span class="at">Rho=</span><span class="fl">0.5</span>,<span class="at">k=</span><span class="dv">10</span>, <span class="at">Eta=</span><span class="fl">0.03</span>,<span class="at">N=</span><span class="dv">38000</span>),</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include.data=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>.id<span class="sc">==</span><span class="st">"data"</span>)) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/sir_sim1_plot-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="2400"></p>
</figure>
</div>
</div>
</div>
<!-- The data are in blue; the 20 simulations are shown in red. -->
<!-- Clearly, this leaves something to be desired.  -->
<!-- In the exercises, you'll see if this model can do better. -->
</section>
</section>
<section id="exercises" class="level1">
<h1>Exercises</h1>
<section id="exercise-i-explore-the-sir-model" class="level2">
<h2 class="anchored" data-anchor-id="exercise-i-explore-the-sir-model">Exercise I: Explore the SIR model</h2>
<p>Fiddle with the parameters to see if you can’t find a model for which the data are a more plausible realization.</p>
</section>
<section id="worked-solutions-i-explore-the-sir-model" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="worked-solutions-i-explore-the-sir-model">Worked solutions I: Explore the SIR model</h2>
<p>In the simulated outbreaks, the overall incidence is much too low, and the outbreak dies out immediately. We might try increasing the force of infection:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">params=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">25</span>,<span class="at">Gamma=</span><span class="fl">0.5</span>,<span class="at">Rho=</span><span class="fl">0.5</span>,<span class="at">k=</span><span class="dv">10</span>,<span class="at">Eta=</span><span class="fl">0.03</span>,<span class="at">N=</span><span class="dv">38000</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include.data=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>.id<span class="sc">==</span><span class="st">"data"</span>)) <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/unnamed-chunk-1-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>Taking it farther…</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">params=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">40</span>,<span class="at">Gamma=</span><span class="fl">0.5</span>,<span class="at">Rho=</span><span class="fl">0.5</span>,<span class="at">k=</span><span class="dv">10</span>,<span class="at">Eta=</span><span class="fl">0.03</span>,<span class="at">N=</span><span class="dv">38000</span>),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include.data=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>.id<span class="sc">==</span><span class="st">"data"</span>)) <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/unnamed-chunk-2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>While this increases the overall incidence, the epidemic is now peaking too quickly. To counteract this, we might try reducing the recovery rate.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">params=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">40</span>,<span class="at">Gamma=</span><span class="fl">0.2</span>,<span class="at">Rho=</span><span class="fl">0.5</span>,<span class="at">k=</span><span class="dv">10</span>,<span class="at">Eta=</span><span class="fl">0.03</span>,<span class="at">N=</span><span class="dv">38000</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include.data=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>.id<span class="sc">==</span><span class="st">"data"</span>))<span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/unnamed-chunk-3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>Additionally, we might have a look at the effects of changing the initial susceptible fraction, <span class="math inline">\(\eta\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">params=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">15</span>,<span class="at">Gamma=</span><span class="fl">0.5</span>,<span class="at">Rho=</span><span class="fl">0.5</span>,<span class="at">k=</span><span class="dv">10</span>,<span class="at">Eta=</span><span class="fl">0.06</span>,<span class="at">N=</span><span class="dv">38000</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include.data=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>.id<span class="sc">==</span><span class="st">"data"</span>)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/unnamed-chunk-4-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="2400"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise-ii-extend-the-sir-model-to-seir-model" class="level2">
<h2 class="anchored" data-anchor-id="exercise-ii-extend-the-sir-model-to-seir-model">Exercise II: Extend the SIR model to SEIR model</h2>
<p>Below is a diagram of the so-called SEIR model. This differs from the SIR model in that infected individuals must pass a period of latency before becoming infectious.</p>
<p>Modify the codes above to construct a <code>pomp</code> object containing the Consett measles data and an SEIR model. Perform simulations as above and adjust parameters to get a sense of whether improvement is possible by including a latent period.</p>
</section>
<section id="worked-solutions-ii-the-seir-model" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="worked-solutions-ii-the-seir-model">Worked solutions II: The SEIR model</h2>
<p>The existing code may be modified as follows:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>seir_stoch <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_SE = rbinom(S,1-exp(-Beta*I/N*dt));</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_EI = rbinom(E,1-exp(-Sigma*dt));</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_IR = rbinom(I,1-exp(-Gamma*dt));</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">  S -= dN_SE;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="st">  E += dN_SE - dN_EI;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="st">  I += dN_EI - dN_IR;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="st">  R += dN_IR;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="st">  H += dN_IR;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>seir_init <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="st">  S = nearbyint(Eta*N);</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="st">  E = 0; I = 1;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="st">  R = nearbyint((1-Eta)*N);</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="st">  H = 0;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pomp</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">rprocess=</span><span class="fu">euler</span>(seir_stoch,<span class="at">delta.t=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">7</span>),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">rinit=</span>seir_init,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">paramnames=</span><span class="fu">c</span>(<span class="st">"N"</span>,<span class="st">"Beta"</span>,<span class="st">"Sigma"</span>,<span class="st">"Gamma"</span>,<span class="st">"Rho"</span>,<span class="st">"Eta"</span>,<span class="st">"k"</span>),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">statenames=</span><span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"E"</span>,<span class="st">"I"</span>,<span class="st">"R"</span>,<span class="st">"H"</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> measSEIR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the rough estimate that the latent period in measles is 8–10da, we take <span class="math inline">\(\sigma\sim 0.8\)</span>wk<sup>-1</sup> and <span class="math inline">\(\gamma\sim 1.3\)</span>wk<sup>-1</sup> (roughly the same generation time as before).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>measSEIR <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">params=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">30</span>,<span class="at">Sigma=</span><span class="fl">0.8</span>,<span class="at">Gamma=</span><span class="fl">1.3</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Rho=</span><span class="fl">0.5</span>,<span class="at">k=</span><span class="dv">10</span>,<span class="at">Eta=</span><span class="fl">0.06</span>,<span class="at">N=</span><span class="dv">38000</span>),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include.data=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>.id<span class="sc">==</span><span class="st">"data"</span>)) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/unnamed-chunk-7-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>Again one can increase the force of infection:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>measSEIR <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">params=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">40</span>,<span class="at">Sigma=</span><span class="fl">0.8</span>,<span class="at">Gamma=</span><span class="fl">1.3</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Rho=</span><span class="fl">0.5</span>,<span class="at">k=</span><span class="dv">10</span>,<span class="at">Eta=</span><span class="fl">0.06</span>,<span class="at">N=</span><span class="dv">38000</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include.data=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>.id<span class="sc">==</span><span class="st">"data"</span>)) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/unnamed-chunk-8-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" data-fig-pos="h!" width="2400"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<section id="references-1" class="level2">
<h2 class="anchored" data-anchor-id="references-1">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Anderson1991" class="csl-entry" role="listitem">
Anderson, R. M., and R. M. May. 1991. <em>Infectious Diseases of Humans</em>. Oxford: Oxford Univesity Press.
</div>
<div id="ref-Breto2009" class="csl-entry" role="listitem">
Bretó, Carles, Daihai He, Edward L. Ionides, and Aaron A. King. 2009. <span>“Time Series Analysis via Mechanistic Models.”</span> <em>Ann Appl Stat</em> 3 (1): 319–48. <a href="https://doi.org/10.1214/08-AOAS201">https://doi.org/10.1214/08-AOAS201</a>.
</div>
</div>
</section>
<section id="license-acknowledgments-and-links" class="level2">
<h2 class="anchored" data-anchor-id="license-acknowledgments-and-links">License, acknowledgments, and links</h2>
<ul>
<li><p>This lesson is prepared for the <a href="https://rubbislam.quarto.pub/episim/">Simulation-based Inference for Epidemiological Dynamics</a> module at the Summer Institute in Statistics and Modeling in Infectious Diseases, <a href="https://sph.emory.edu/SISMID/index.html">SISMID</a>.</p></li>
<li><p>The materials build on <a href="../acknowledge.html">previous versions of this course and related courses</a>.</p></li>
<li><p>Licensed under the <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial license</a>. Please share and remix non-commercially, mentioning its origin. </p></li>
<li><p>Produced with R version 4.4.0 and pomp version 5.9.</p></li>
<li><p>Compiled on 2024-07-24.</p></li>
</ul>
<p><a href="index.html">Back to Lesson</a></p>
<p><a href="./main.R"><code>R</code> code for this lesson</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>