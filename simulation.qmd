---
title: "Simulation"
author: "Qianying (Ruby) Lin"
toc: true
format:
  html:
    embed-resources: true
    code-background: true
engine: knitr
---

## Summary

-   Compartment model introduction
    -   SIR model, deterministic
    -   SIR model, stochastic
-   Model with observations
    -   SIR model with a diagnosis compartment
-   Partially Observed Markov Process (POMP)
    -   state process and measurement model
    -   SIR model in a POMP model

## Installation of related packages

We will be using `pomp`, `tidyverse`, and `ggplot2` across this series of sessions. For Windows users, please go to <https://cran.r-project.org/bin/windows/Rtools/>, download and install `RTools 4.4` first. For all platform users, please install `pomp` by running command

```         
install.packages("pomp")
```

within RStudio Console.

## Introduction to Epidemiological Compartmental Models

Compartment models, such as Susceptible-Infected-Recovered (SIR) model, divide the total population into different groups (i.e., compartments) and model the dynamics for each group by incorporating transitions between them. We can use diagrams to illustrate the model structures and the events (transitions) between compartments and formulate the dynamics using ODEs.

### Example: SIR model

![**SIR model diagram**. Three compartments are included in this presented SIR model, with two events: transmission (i.e. S to I) with per-capita rate $\beta\,I$ and recovery (i.e. I to R) with per-capita rate $\gamma$.](SIR.png){width="300"}

```{=tex}
\begin{aligned}
  \frac{d S}{d t} &= -\beta S \frac{I}{N} \\
  \frac{d I}{d t} &= \beta S \frac{I}{N} - \gamma I \\
  \frac{d R}{d t} &= \gamma I \\
  N &= S + I + R
\end{aligned}
```
## Simulate the SIR model

### A deterministic model

Based on the ODEs, we can write a function to simulate **one-step-transition** of the deterministic SIR model:

```{r SIR-deterministic}
sir_determ_step <- function (S, I, R, N, Beta, gamma, delta.t, ...) {
  dN_SI <- Beta * I * S / N * delta.t
  dN_IR <- gamma * I * delta.t
  S <- S - dN_SI
  I <- I + dN_SI - dN_IR
  R <- R + dN_IR
  return (c(S = S, I = I, R = R))
}
```

To simulate the full dynamics of the proposed SIR model, we also need the initial values for $S$, $I$, and $R$, which we denote as $S_0$, $I_0$, and $R_0$.

```{r init}
sir_init <- function (S0, I0, R0) {
  return(c(S = S0, I = I0, R = R0))
}
```

Now we can combine the initialization function and the one-step-transition function to simulate the deterministic SIR dynamics:

```{r sir-determ-sim}
# initialize the system
inits <- sir_init(S0=9999, I0=1, R0=0)
# restore the results
results <- data.frame(t = 0, S = inits[1], I = inits[2], R = inits[3])
# the end time and time step
t <- 0
tend <- 200
delta.t <- 1
# parameter setting
params <- c(Beta = 0.1, gamma = 0.01)
while (t < tend) {
  t <- t + delta.t
  prev_states <- results[nrow(results),]
  current_states <- sir_determ_step(
    S = prev_states$S,
    I = prev_states$I,
    R = prev_states$R,
    N = prev_states$S + prev_states$I + prev_states$R,
    Beta = params["Beta"],
    gamma = params["gamma"],
    delta.t = delta.t
  )
  results <- rbind(
    results,
    c(t = t, S = current_states[1], I = current_states[2], R = current_states[3])
  )
}

library(dplyr)
library(ggplot2)

ggplot(data = results, aes(x = t)) +
  geom_line(aes(y = S), color="darkgreen") + 
  geom_line(aes(y = I), color="red")+ 
  geom_line(aes(y = R), color="blue") +
  labs(x = "time", y = "population") +
  theme_minimal() -> p_determin

p_determin

# zoom-in
p_determin +
  coord_cartesian(xlim=c(120,130), ylim=c(6e3, 7e3))
```

### A stochastic model

To make the model more realistic, we incorporate some level of stochasticity in each transitions assuming the number of individuals in each transitions follows a binomial distribution:

```{r SIR-stochastic}
sir_stoch_step <- function (S, I, R, N, Beta, gamma, delta.t, ...) {
  dN_SI <- rbinom(n=1, size=S, prob=1-exp(-Beta * I / N * delta.t))
  dN_IR <- rbinom(n=1, size=I, prob=1-exp(-gamma * delta.t))
  S <- S - dN_SI
  I <- I + dN_SI - dN_IR
  R <- R + dN_IR
  return (c(S = S, I = I, R = R))
}
```

Again we can simulate this stochastic SIR model:

```{r sir-stoch-sim}
# initialize the system
inits <- sir_init(S0=9999, I0=1, R0=0)
# restore the results
results <- data.frame(t = 0, S = inits[1], I = inits[2], R = inits[3])
# the end time and time step
t <- 0
tend <- 200
delta.t <- 1
# parameter setting
params <- c(Beta = 0.1, gamma = 0.01)
while (t < tend) {
  t <- t + delta.t
  prev_states <- results[nrow(results),]
  current_states <- sir_stoch_step(
    S = prev_states$S,
    I = prev_states$I,
    R = prev_states$R,
    N = prev_states$S + prev_states$I + prev_states$R,
    Beta = params["Beta"],
    gamma = params["gamma"],
    delta.t = delta.t
  )
  results <- rbind(
    results,
    c(t = t, S = current_states[1], I = current_states[2], R = current_states[3])
  )
}

library(dplyr)
library(ggplot2)

ggplot(data = results, aes(x = t)) +
  geom_line(aes(y = S), color="darkgreen") + 
  geom_line(aes(y = I), color="red") + 
  geom_line(aes(y = R), color="blue") +
  labs(x = "time", y = "population") +
  theme_minimal() -> p_stoch

p_stoch

p_stoch +
  coord_cartesian(xlim=c(120,130), ylim=c(6e3, 7e3))
```

### Try some other models?

## SIR model + observations

Unfortunately, we don't observed all states ($S$, $I$, and $R$).

### SIR model with a diagnosis compartment

We assume that the infections (i.e. patients) go to the hospitial and get diagnosed and denote this new compartment as $D$:

![**SIR + Diagnosis model diagram**.](SIRD.png){width="300"}

```{=tex}
\begin{aligned}
  \frac{d S}{d t} &= -\beta S \frac{I}{N} \\
  \frac{d I}{d t} &= \beta S \frac{I}{N} - \gamma I \\
  \frac{d R}{d t} &= \gamma I \\
  \frac{d D}{d t} &= \gamma I \\
  N &= S + I + R
\end{aligned}
```
Now we define a new one-step-transition function:

```{r SIRD-stoch}
sird_stoch_step <- function (S, I, R, N, D, Beta, gamma, delta.t, ...) {
  dN_SI <- rbinom(n=1, size=S, prob=1-exp(-Beta * I / N * delta.t))
  dN_IR <- rbinom(n=1, size=I, prob=1-exp(-gamma * delta.t))
  S <- S - dN_SI
  I <- I + dN_SI - dN_IR
  R <- R + dN_IR
  D <- D + dN_IR
  return (c(S = S, I = I, R = R, D = D))
}
```

with the new initialization function:

```{r SIRD-init}
sird_init <- function (S0, I0, R0, D0=0) {
  return(c(S = S0, I = I0, R = R0, D = D0))
}
```

## Partially Observed Markov Process (POMP)

What's worse, we cannot even observe the true values of any state. We only have partial observations within a period of time, let's say, 7 days.

### State process and measurement model

In the POMP model, we have two main components: the underlying state process and measurement model to the observations.

![**POMP structure**.](POMP.png){width="300"}

Let's break it into details, defining the underlying state process as $X_t$ and the observed measurements as $Y_t$, both of which are markovian.

![**POMP schematic**.](POMP2.png){width="500"}

### SIR model in a POMP model

Now we can define the **state process** as a stochastic SIR model, $X_t = (S_t, I_t, R_t, D_t)$, where we call $D_t$ as the weekly cumulative diagnoses, which **resets to 0** every 7 days.

We further can define a weekly measurement model: $$
\textrm{reports}_t \sim \textrm{NegBin}(\rho D_t, k),
$$ where $\rho$ is the reporting ratio and $k$ is the dispersion parameter in the Negative Binomial distribution. Of course, we can also define the measurement model as a Binomial distribution or Poisson distribution.

Using this measurement model, we can have the probability a case report given the true diagnoses, as well as simulate the reported cases based on the SIR with diagnosis model:

```{r sird_measurement}
## density/probability
sird_dmeas <- function (reports, D, rho, k, log, ...) {
  dnbinom(x=reports, size=k, mu=rho*D, log=log)
}

## simulation
sird_rmeas <- function (D, rho, k, ...) {
  return (c(reports=rnbinom(n=1, size=k, mu=rho*D)))
}
```

We can update the **one-step transition** function:

```{r sird_stoch_pomp}
sird_stoch_pomp_step <- function (S, I, R, N, D, Beta, gamma, t, delta.t, cum_step, ...) {
  dN_SI <- rbinom(n=1, size=S, prob=1-exp(-Beta * I / N * delta.t))
  dN_IR <- rbinom(n=1, size=I, prob=1-exp(-gamma * delta.t))
  S <- S - dN_SI
  I <- I + dN_SI - dN_IR
  R <- R + dN_IR
  if (t %% cum_step == 1)  D <- 0
  D <- D + dN_IR
  return (c(S = S, I = I, R = R, D = D))
}
```

Now we can simulate the underlying SIRD models and the reported cases:

```{r sird-stoch-pomp-sim}
# initialize the system
inits <- sird_init(S0=9999, I0=1, R0=0, D0=0)
# restore the results
results <- data.frame(t = 0, S = inits[1], I = inits[2], R = inits[3], D = inits[4], reports = 0)
# the end time and time steps
t <- 0
tend <- 200
delta.t <- 1
cum_step <- 7
# parameter setting
params <- c(Beta = 0.1, gamma = 0.01, rho=0.2, k=3)
while (t < tend) {
  t <- t + delta.t
  prev_states <- results[nrow(results),]
  current_states <- sird_stoch_pomp_step(
    S = prev_states$S,
    I = prev_states$I,
    R = prev_states$R,
    N = prev_states$S + prev_states$I + prev_states$R,
    D = prev_states$D, 
    Beta = params["Beta"],
    gamma = params["gamma"],
    t = t,
    delta.t = delta.t,
    cum_step = cum_step
  )
  reports <- 0
  if (t %% cum_step == 0)
    reports <- sird_rmeas(D = current_states[4], rho = params["rho"], k = params["k"])
  results <- rbind(
    results,
    c(t = t, S = current_states[1], I = current_states[2], R = current_states[3], D = current_states[4], reports = reports[1])
  )
}

library(dplyr)
library(ggplot2)

ggplot(data = results, aes(x = t)) +
  geom_line(aes(y = S), color="darkgreen") + 
  geom_line(aes(y = I), color="red") + 
  geom_line(aes(y = R), color="blue") +
  geom_line(aes(y = D), color="grey") +
  geom_step(aes(y = reports), color="black") +
  labs(x = "time", y = "population") +
  scale_y_log10() +
  theme_minimal() -> p_stoch_pomp

p_stoch_pomp
```
