<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aaron A. King and Edward L. Ionides">

<title>EpiSim - Exercise: Fitting the SEIR model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
MathJax = {
  loader: {
    load: ['[tex]/boldsymbol']
  },
  tex: {
    tags: "all",
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    packages: {
      '[+]': ['boldsymbol']
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">EpiSim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../instruction.html" rel="" target="">
 <span class="menu-text">Instruction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../introduction.html" rel="" target="">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../simulation.html" rel="" target="">
 <span class="menu-text">Simulation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../likelihood.html" rel="" target="">
 <span class="menu-text">Likelihood</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../iterated.html" rel="" target="">
 <span class="menu-text">Iterated filtering</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../Bayesian.html" rel="" target="">
 <span class="menu-text">Bayesian</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../case study.html" rel="" target="">
 <span class="menu-text">Case study</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#problem-statement" id="toc-problem-statement" class="nav-link active" data-scroll-target="#problem-statement">Problem Statement</a></li>
  <li><a href="#setup-and-check" id="toc-setup-and-check" class="nav-link" data-scroll-target="#setup-and-check">Setup and check</a>
  <ul class="collapse">
  <li><a href="#sanity-check" id="toc-sanity-check" class="nav-link" data-scroll-target="#sanity-check">Sanity check</a></li>
  <li><a href="#setup-of-parallel-computing-environment" id="toc-setup-of-parallel-computing-environment" class="nav-link" data-scroll-target="#setup-of-parallel-computing-environment">Setup of parallel computing environment</a></li>
  </ul></li>
  <li><a href="#local-search" id="toc-local-search" class="nav-link" data-scroll-target="#local-search">Local search</a></li>
  <li><a href="#run-level-1" id="toc-run-level-1" class="nav-link" data-scroll-target="#run-level-1">Run-level 1</a></li>
  <li><a href="#run-level-2" id="toc-run-level-2" class="nav-link" data-scroll-target="#run-level-2">Run-level 2</a></li>
  <li><a href="#run-level-3" id="toc-run-level-3" class="nav-link" data-scroll-target="#run-level-3">Run-level 3</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exercise: Fitting the SEIR model</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Aaron A. King and Edward L. Ionides </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<hr>
<p><a href="./Q_fit_seir.R"><strong>R codes for this document</strong></a></p>
<hr>
<section id="problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="problem-statement">Problem Statement</h2>
<p>In this exercise, you will estimate the parameters and likelihood of the SEIR model you implemented in the earlier lessons by following the template above. Purely for the sake of simplicity, you may assume that the values of <span class="math inline">\(\mu_{IR}\)</span> and <span class="math inline">\(k\)</span> are known. To do this efficiently, we will make use of a system of <em>run-levels</em>. At each run-level, we will select some number of particles (<code>Np</code>), number of IF2 iterations (<code>Nmif</code>), and number of starting guesses, to achieve a particular result.</p>
<ol type="A">
<li><p>First, conduct a local search and compute the likelihood at the end of each <code>mif2</code> run, as shown above. Use only as many parallel <code>mif2</code> computations as you have processors on your computer (or perhaps somewhat fewer). Track the time used and compute the amount of time used per cpu per IF2 iteration per 1000 particles. (Recall that one particle filter computation is roughly equal to a IF2 iteration in computational complexity if they both use the same number of particles.)</p></li>
<li><p>At run-level 1, we want a quick calculation that verifies that the codes are working as expected. Using the expense estimates you generated in Step&nbsp;(a), choose a number of IF2 iterations so that you can do a very crude “global search” that will complete in two or three minutes. Do not reduce <code>Np</code> drastically, as we don’t want to degrade the performance of the individual IF2 computations. Run your global search with these settings. This serves to debug your global search code.</p></li>
<li><p>At run-level 2, we want a computation that gives us some results we can begin to interpret, but that is still as quick as possible. Choose <code>Nmif</code> and the number of random starts so that you can obtain the beginnings of a global search of the parameter space in one hour or less. Run your global search with these settings and plot the results.</p></li>
<li><p>Run-level 3 is intended for final or near-final results. You may want to tune your settings (<code>Nmif</code>, <code>Np</code>, <code>rw.sd</code>, <code>cooling.fraction.50</code>) at this point, based on what you found at run-level 2. Decide how much time in the next 18 hours is available to you for a computation. Choose the number of starting guesses so that you can obtain as thorough a global search as possible within this period. Run your global search and identify a maximum likelihood estimate.</p></li>
<li><p>How does the SEIR model compare with the SIR model? Discuss the overall quality of the fit as well as important differences in how the two models are explaining the data.</p></li>
</ol>
<hr>
</section>
<section id="setup-and-check" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-check">Setup and check</h2>
<p>We start by building a pomp object holding the Consett measles data and the SEIR process model from <a href="../stochsim/exercises.html#basic-exercise-the-seir-model">Exercise 2.4</a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pomp)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(iterators)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (.Platform<span class="sc">$</span>OS.type<span class="sc">==</span><span class="st">"windows"</span>) </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">pomp_cdir=</span><span class="st">"./tmp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/sir_model_a5080d01927dee185544340eba9aa309">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"model_measSIR.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/seir_pomp_5dd5b58b16bac86b345c7dab52545140">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>seir_stoch <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_SE = rbinom(S,1-exp(-Beta*I/N*dt));</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_EI = rbinom(E,1-exp(-Sigma*dt));</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">  double dN_IR = rbinom(I,1-exp(-Gamma*dt));</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">  S -= dN_SE;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">  E += dN_SE - dN_EI;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">  I += dN_EI - dN_IR;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">  R += dN_IR;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">  H += dN_IR;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>seir_rinit <span class="ot">&lt;-</span> <span class="fu">Csnippet</span>(<span class="st">"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="st">  S = nearbyint(Eta*N);</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="st">  E = 0;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="st">  I = 1;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="st">  R = nearbyint((1-Eta)*N);</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="st">  H = 0;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pomp</span>(</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">rprocess=</span><span class="fu">euler</span>(seir_stoch,<span class="at">delta.t=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">7</span>),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">rinit=</span>seir_rinit,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">partrans=</span><span class="fu">parameter_trans</span>(</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">log=</span><span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Sigma"</span>),</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">logit=</span><span class="fu">c</span>(<span class="st">"Eta"</span>,<span class="st">"Rho"</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">paramnames=</span><span class="fu">c</span>(<span class="st">"N"</span>,<span class="st">"Beta"</span>,<span class="st">"Sigma"</span>,<span class="st">"Gamma"</span>,<span class="st">"Eta"</span>,<span class="st">"k"</span>,<span class="st">"Rho"</span>),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">statenames=</span><span class="fu">c</span>(<span class="st">"S"</span>,<span class="st">"E"</span>,<span class="st">"I"</span>,<span class="st">"R"</span>,<span class="st">"H"</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> measSEIR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we’ll use the best parameters we’ve found so far. We simply extract these from the database and insert them into our new ‘pomp’ object, <code>measSEIR</code>.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/set_params_d842aa94436576a5be656869a271ad5c">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(Gamma<span class="dv">-2</span>)<span class="sc">&lt;</span><span class="fl">0.001</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">==</span><span class="fu">max</span>(loglik)) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>loglik,<span class="sc">-</span>loglik.se) <span class="ot">-&gt;</span> <span class="fu">coef</span>(measSEIR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1299 Columns: 8
── Column specification ────────────────────────────────────
Delimiter: ","
dbl (8): Beta, Gamma, Rho, k, Eta, N, loglik, loglik.se

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>The SEIR model has one parameter that the SIR had not, namely <span class="math inline">\(\mu_{EI}\)</span>, the rate at which infections progress from the latent to the infectious stage. We take a guess for this parameter and insert it into the ‘pomp’ object using <code>coef&lt;-</code>:</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/set_new_params_7d3f8c6deb2f52077de3c4ddf2382505">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(measSEIR,<span class="st">"Sigma"</span>) <span class="ot">&lt;-</span> <span class="fl">0.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: in 'coef&lt;-': name 'Sigma' refers to no existing
parameter; it is being concatenated.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fixed_params <span class="ot">&lt;-</span> <span class="fu">coef</span>(measSEIR,<span class="fu">c</span>(<span class="st">"N"</span>,<span class="st">"Gamma"</span>,<span class="st">"k"</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(measSEIR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Beta        Gamma          Rho            k 
3.629251e+00 2.000000e+00 5.569420e-02 1.000000e+01 
         Eta            N        Sigma 
6.125641e-01 3.800000e+04 8.000000e-01 </code></pre>
</div>
</div>
<p>The warning tells us that <code>Sigma</code> is a new parameter, which, of course, we knew.</p>
<p>Because this is just an exercise, we are only estimating four parameters. For a thorough scientific analysis, we would probably also want to consider the evidence in the data concerning the parameters that are fixed here.</p>
<section id="sanity-check" class="level3">
<h3 class="anchored" data-anchor-id="sanity-check">Sanity check</h3>
<p>To debug the model and provide a sanity check on our parameter guesses, we first explore via simulation. Some simulations die out, but others lead to epidemics.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/simulate_3f9bfdc8dac78dba0477a078aaf0b95a">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1014406</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>measSEIR <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(<span class="at">nsim=</span><span class="dv">20</span>,<span class="at">format=</span><span class="st">"data.frame"</span>,<span class="at">include=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>reports,<span class="at">group=</span>.id,<span class="at">color=</span>(.id<span class="sc">==</span><span class="st">"data"</span>)))<span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/simulate-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
<p>The next prerequisite is that we can successfully filter:</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/pfilter_ad68c8fd17e9833fb39f60990de7d16e">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>measSEIR <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">1000</span>) <span class="ot">-&gt;</span> pf1</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">logLik</span>(pf1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -251.9792</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pf1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/pfilter-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
<p>The minimum effective sample size is 12, which is not a complete disaster, and we should bear in mind that this is likely to improve when we fit the parameters.</p>
</section>
<section id="setup-of-parallel-computing-environment" class="level3">
<h3 class="anchored" data-anchor-id="setup-of-parallel-computing-environment">Setup of parallel computing environment</h3>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/mycores_5ccfc1de6a3fc2f4a6002271274d1224">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="local-search" class="level2">
<h2 class="anchored" data-anchor-id="local-search">Local search</h2>
<p>We now carry out the local search. Here, we’re cooling quite slowly: the perturbation magnitude at the fiftieth iteration is half of what it was at the first.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/local_search_d57144550b6d187340cf5dc7be6ba56c">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ncpu <span class="ot">&lt;-</span> <span class="fu">nbrOfWorkers</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(<span class="at">file=</span><span class="st">"Q_fit_seir_local_mifs.rds"</span>,{</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i=</span><span class="fu">seq_len</span>(ncpu),<span class="at">.combine=</span>c,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">482947940</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%dofuture%</span> {</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    measSEIR <span class="sc">|&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mif2</span>(</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">Np=</span><span class="dv">1000</span>, <span class="at">Nmif=</span><span class="dv">50</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">cooling.fraction.50=</span><span class="fl">0.5</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>, <span class="at">Rho=</span><span class="fl">0.02</span>, <span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>), <span class="at">Sigma=</span><span class="fl">0.02</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>}) <span class="ot">-&gt;</span> local_mifs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We examine the trace plots</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/local_mifs_traces_82694253dcd54e0132fe64539af7d902">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>local_mifs <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">traces</span>(<span class="at">pars=</span><span class="fu">c</span>(<span class="st">"loglik"</span>,<span class="st">"Beta"</span>,<span class="st">"Sigma"</span>,<span class="st">"Rho"</span>,<span class="st">"Eta"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>iteration,<span class="at">y=</span>value,<span class="at">group=</span>.L1,<span class="at">color=</span><span class="fu">factor</span>(.L1)))<span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name,<span class="at">scales=</span><span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/local_mifs_traces-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
<p>As usual, we should evaluate the likelihoods using a particle filter, rather than relying on the likelihood from the last filtering iteration of the perturbed model used by <code>mif2</code>.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/local_search_evaluations_b990f10bcd3c832afc9cfe67f0d96dea">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(<span class="at">file=</span><span class="st">"Q_fit_seir_local_logliks.rds"</span>,{</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">mf=</span>local_mifs,<span class="at">.combine=</span>rbind,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">901242057</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%dofuture%</span> {</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    evals <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">10</span>, <span class="fu">logLik</span>(<span class="fu">pfilter</span>(mf,<span class="at">Np=</span><span class="dv">2000</span>)))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    ll <span class="ot">&lt;-</span> <span class="fu">logmeanexp</span>(evals,<span class="at">se=</span><span class="cn">TRUE</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>],<span class="at">Np=</span><span class="dv">2000</span>,<span class="at">nfilt=</span><span class="dv">10</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>}) <span class="ot">-&gt;</span> local_logliks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/local_logliks_display_bcbeec45cc6a31c05ceb890aece3ce0b">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>local_logliks<span class="sc">$</span>loglik</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      est       est       est       est       est       est 
-105.0946 -104.8637 -104.9382 -105.1521 -104.5660 -104.5627 
      est       est       est       est 
-104.7274 -104.8749 -104.4435 -105.3890 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>local_logliks<span class="sc">$</span>loglik.se</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        se         se         se         se         se 
0.04509426 0.05585337 0.04897253 0.06432649 0.05333849 
        se         se         se         se         se 
0.03304969 0.04582491 0.03639205 0.03924775 0.04348803 </code></pre>
</div>
</div>
<p>After 50 IF2 iterations, the log likelihoods appear to have already reached the vicinity of what we found for the SIR model, with small s.e. (<a href="https://kingaa.github.io/sbied/pfilter/loglikest.html">if <code>logmeanexp</code> is to be trusted</a>). Moreover, the trace-plots suggest that further improvement is possible.</p>
<p>Now, we quantify the amount of time required for the above. Note that we used <code>bake</code> to archive the results of the above two computations. [<a href="https://kingaa.github.io/sbied/misc/bake.html">More about <code>bake</code> here.</a>]. The archives store not only the results, but also information about the time elapsed. Accordingly, the first line in the following adds up the total time needed for these two computations. The second and third lines add up the total amount of work, which we have seen is jointly proportional to number of <code>mif2</code> or <code>pfilter</code> iterations and to the number of particles used. Recall that the complexity of one <code>mif2</code> iteration is roughly equal to that of one <code>pfilter</code> operation with the same number of particles. In line four, <code>efactor</code> is computed as the average number of CPU-sec needed for a 1000-particle <code>pfilter</code> operation.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/local_search_timing_6775c4b2a75f5c9075c7958263a9fcaf">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>etime <span class="ot">&lt;-</span> <span class="fu">attr</span>(local_mifs,<span class="st">"system.time"</span>)<span class="sc">+</span><span class="fu">attr</span>(local_logliks,<span class="st">"system.time"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>mif_work <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(local_mifs,slot,<span class="st">"Nmif"</span>)<span class="sc">*</span><span class="fu">apply</span>(<span class="fu">sapply</span>(local_mifs,slot,<span class="st">"Np"</span>),<span class="dv">2</span>,mean))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>pfilter_work <span class="ot">&lt;-</span> <span class="fu">with</span>(local_logliks,<span class="fu">sum</span>(Np<span class="sc">*</span>nfilt))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>efactor <span class="ot">&lt;-</span> <span class="fu">unname</span>(etime[<span class="dv">3</span>]<span class="sc">*</span>ncpu<span class="sc">/</span>(mif_work<span class="sc">+</span>pfilter_work)<span class="sc">*</span><span class="dv">1000</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>efactor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1631714</code></pre>
</div>
</div>
</section>
<section id="run-level-1" class="level2">
<h2 class="anchored" data-anchor-id="run-level-1">Run-level 1</h2>
<p>We proceed to design a global search. At run-level 1, we just want something that will run very quickly but that we can scale up easily. Let aim for something that will complete in 1 minute. Using 1000 particles for <code>mif2</code> and 2000 for the <code>pfilter</code> likelihood evaluation seems to be working well, so let’s leave those alone. After 50 iterations, it seemed that IF2 was still increasing the likelihood, so perhaps we might increase the number of IF2 iterations somewhat, let’s say to 100. We’ll leave the cooling fraction alone, so that perturbations at the last iteration will be 25% of what they were at the first. How many starts can we have and finish in 1&nbsp;min?</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/runlevel1_est_c0f8341aacd5c7966efe5d2800d37604">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>unit_cost <span class="ot">&lt;-</span> (<span class="dv">100</span><span class="sc">*</span><span class="dv">1000</span><span class="sc">+</span><span class="dv">10</span><span class="sc">*</span><span class="dv">2000</span>)<span class="sc">/</span><span class="dv">1000</span><span class="sc">*</span>efactor</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>budget <span class="ot">&lt;-</span> <span class="dv">60</span><span class="sc">*</span>ncpu</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>budget<span class="sc">/</span>unit_cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  system 
30.64262 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/global_search_1a_5987b31e4d599278598a450ac6f2f0cb">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">freeze</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif_design</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">5</span>,<span class="at">Rho=</span><span class="fl">0.2</span>,<span class="at">Eta=</span><span class="dv">0</span>,<span class="at">Sigma=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">80</span>,<span class="at">Rho=</span><span class="fl">0.9</span>,<span class="at">Eta=</span><span class="dv">1</span>,<span class="at">Sigma=</span><span class="dv">3</span>),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nseq=</span><span class="dv">45</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed=</span><span class="dv">2062379496</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>)<span class="ot">-&gt;</span> guesses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/global_search_1_eval_773d61f7c7a8fcd3f75c171c482c032c">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(<span class="at">file=</span><span class="st">"Q_fit_seir_global1.rds"</span>,{</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">guess=</span><span class="fu">iter</span>(guesses,<span class="st">"row"</span>), <span class="at">.combine=</span>rbind,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">1270401374</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%dofuture%</span> {</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    measSEIR <span class="sc">|&gt;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mif2</span>(</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">Nmif=</span><span class="dv">100</span>, <span class="at">Np=</span><span class="dv">1000</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">cooling.fraction.50=</span><span class="fl">0.5</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>, <span class="at">Rho=</span><span class="fl">0.02</span>, <span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>), <span class="at">Sigma=</span><span class="fl">0.02</span>),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">params=</span><span class="fu">c</span>(<span class="fu">unlist</span>(guess),fixed_params)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>      ) <span class="ot">-&gt;</span> mf</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">replicate</span>(</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>      <span class="dv">10</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      mf <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">2000</span>) <span class="sc">|&gt;</span> <span class="fu">logLik</span>()</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ll</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  } <span class="ot">-&gt;</span> global1</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(global1,<span class="st">"ncpu"</span>) <span class="ot">&lt;-</span> <span class="fu">nbrOfWorkers</span>()</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  global1</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>}) <span class="ot">-&gt;</span> global1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sure enough, the above took 48.1010&nbsp;sec to run on 10&nbsp;CPU. Let us examine the results.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/scatter_plot1_48e5d335a10acfc93ce448c14ab3fea5">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>loglik<span class="sc">+</span>Beta<span class="sc">+</span>Eta<span class="sc">+</span>Rho<span class="sc">+</span>Sigma,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>global1,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch=</span><span class="dv">16</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/scatter_plot1-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
<p>Even with just this small amount of effort, we’re beginning to see some structure emerge. This is encouraging, so we’ll continue on to the next stage of the Exercise.</p>
</section>
<section id="run-level-2" class="level2">
<h2 class="anchored" data-anchor-id="run-level-2">Run-level 2</h2>
<p>Now let’s scale this up to something that we can begin to take seriously. While we’re at it, we’ll throw some more computational power at the problem, and subject all our estimates to a second round of IF2, for a total of 200 IF2 iterations altogether. If we budget 5&nbsp;min, how many starts can we afford?</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/runlevel2_est_ebfb71e11995bb20f3aa6db7994e68e9">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>unit_cost <span class="ot">&lt;-</span> (<span class="dv">200</span><span class="sc">*</span><span class="dv">1000</span><span class="sc">+</span><span class="dv">10</span><span class="sc">*</span><span class="dv">2000</span>)<span class="sc">/</span><span class="dv">1000</span><span class="sc">*</span>efactor</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>budget <span class="ot">&lt;-</span> <span class="dv">5</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span>ncpu</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>budget<span class="sc">/</span>unit_cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  system 
83.57078 </code></pre>
</div>
</div>
<p>For this second set of 100 iterations, we’ll speed up the cooling. We accomplish this using <code>continue</code>, as shown below and explained <a href="https://kingaa.github.io/manuals/pomp/html/continue.html">in the manual</a>. The following should look very much like the corresponding run-level 1 chunk, which is the point: it is easy to scale the computations up.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/global_search_2a_4b6c325bbe1f445f86f85270cbd33d17">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">freeze</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif_design</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">5</span>,<span class="at">Rho=</span><span class="fl">0.2</span>,<span class="at">Eta=</span><span class="dv">0</span>,<span class="at">Sigma=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">80</span>,<span class="at">Rho=</span><span class="fl">0.9</span>,<span class="at">Eta=</span><span class="dv">1</span>,<span class="at">Sigma=</span><span class="dv">3</span>),</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nseq=</span><span class="dv">150</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed=</span><span class="dv">2062379496</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>)<span class="ot">-&gt;</span> guesses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/global_search_2_eval_3a71e216b4f4ce107cf56ba30ef6daf2">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(<span class="at">file=</span><span class="st">"Q_fit_seir_global2.rds"</span>,{</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">guess=</span><span class="fu">iter</span>(guesses,<span class="st">"row"</span>), <span class="at">.combine=</span>rbind,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">1270401374</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%dofuture%</span> {</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    measSEIR <span class="sc">|&gt;</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mif2</span>(</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">Nmif=</span><span class="dv">100</span>, <span class="at">Np=</span><span class="dv">1000</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">cooling.fraction.50=</span><span class="fl">0.5</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>, <span class="at">Rho=</span><span class="fl">0.02</span>, <span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>), <span class="at">Sigma=</span><span class="fl">0.02</span>),</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">params=</span><span class="fu">c</span>(<span class="fu">unlist</span>(guess),fixed_params)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">continue</span>(</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">cooling.fraction=</span><span class="fl">0.1</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>      ) <span class="ot">-&gt;</span> mf</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">replicate</span>(</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>      <span class="dv">10</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>      mf <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">2000</span>) <span class="sc">|&gt;</span> <span class="fu">logLik</span>()</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ll</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>  } <span class="ot">-&gt;</span> global2</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(global2,<span class="st">"ncpu"</span>) <span class="ot">&lt;-</span> <span class="fu">nbrOfWorkers</span>()</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>  global2</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>}) <span class="ot">-&gt;</span> global2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The above computation took 2.5&nbsp;min using 10 cores.</p>
<p>Again, we have a look at the results. The suspicion that the structure of the likelihood surface is beginning to emerge is strengthened.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/scatter_plot2_83b7e4ccda493fa8528be9ee7249edc5">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>loglik<span class="sc">+</span>Beta<span class="sc">+</span>Eta<span class="sc">+</span>Rho<span class="sc">+</span>Sigma,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>global2,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch=</span><span class="dv">16</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/scatter_plot2-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="run-level-3" class="level2">
<h2 class="anchored" data-anchor-id="run-level-3">Run-level 3</h2>
<p>At run-level 3, we want near-final results. We’ll increase the thoroughness of the global search by increasing the number of starts. If we budget 30&nbsp;min, how many starts can we afford?</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/runlevel3_est_790ee80d421c0c4308d00c12a79c94ac">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>unit_cost <span class="ot">&lt;-</span> (<span class="dv">200</span><span class="sc">*</span><span class="dv">1000</span><span class="sc">+</span><span class="dv">10</span><span class="sc">*</span><span class="dv">2000</span>)<span class="sc">/</span><span class="dv">1000</span><span class="sc">*</span>efactor</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>budget <span class="ot">&lt;-</span> <span class="dv">30</span><span class="sc">*</span><span class="dv">60</span><span class="sc">*</span>ncpu</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>budget<span class="sc">/</span>unit_cost</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  system 
501.4247 </code></pre>
</div>
</div>
<p>We proceed exactly as before, but with more starts.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/global_search_3a_d09e45f30fd7820ae0d73ec9237ae14a">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">freeze</span>(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif_design</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">5</span>,<span class="at">Rho=</span><span class="fl">0.2</span>,<span class="at">Eta=</span><span class="dv">0</span>,<span class="at">Sigma=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">80</span>,<span class="at">Rho=</span><span class="fl">0.9</span>,<span class="at">Eta=</span><span class="dv">1</span>,<span class="at">Sigma=</span><span class="dv">3</span>),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nseq=</span><span class="dv">1000</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed=</span><span class="dv">2062379496</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)<span class="ot">-&gt;</span> guesses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/global_search_3b_8ef3fe52a2404d67d8cab007e4d5e3fd">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Uncomment this code chunk to perform the run-level 3 calculation!</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">guess=</span><span class="fu">iter</span>(guesses,<span class="st">"row"</span>), <span class="at">.combine=</span>rbind,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">1270401374</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dofuture%</span> {</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  measSEIR <span class="sc">|&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">Nmif=</span><span class="dv">100</span>, <span class="at">Np=</span><span class="dv">1000</span>,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">cooling.fraction.50=</span><span class="fl">0.5</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>, <span class="at">Rho=</span><span class="fl">0.02</span>, <span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>), <span class="at">Sigma=</span><span class="fl">0.02</span>),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">params=</span><span class="fu">c</span>(<span class="fu">unlist</span>(guess),fixed_params)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">continue</span>(</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">cooling.fraction=</span><span class="fl">0.1</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="ot">-&gt;</span> mf</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    mf <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">2000</span>) <span class="sc">|&gt;</span> <span class="fu">logLik</span>()</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ll</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> global3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that a few of these computations result in non-finite log likelihoods and that others lead to variability in the log likelihood estimates that is uncomfortably large (e.g., <code>loglik.se &gt; 0.2</code>). However, almost all of the estimates that are within 10 units of the maximum are estimated fairly precisely.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/global3_assess_32cd81f4d5f83ded4c8226990d018ce5">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>global3 <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">finite=</span><span class="fu">is.finite</span>(loglik),</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">precise=</span>loglik.se<span class="sc">&gt;</span><span class="fl">0.2</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">high=</span>loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">-</span><span class="dv">10</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> finite precise  high   n
  FALSE      NA    NA   6
   TRUE   FALSE FALSE 112
   TRUE   FALSE  TRUE 462
   TRUE    TRUE FALSE 417
   TRUE    TRUE  TRUE   1
   TRUE      NA FALSE   2</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/scatter_plot3_c4c1d57cd0056c1fcd4813fc04489fa2">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>global3 <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">is.finite</span>(loglik),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik,<span class="at">na.rm=</span><span class="cn">TRUE</span>)<span class="sc">-</span><span class="dv">10</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> global3</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>loglik<span class="sc">+</span>Beta<span class="sc">+</span>Eta<span class="sc">+</span>Rho<span class="sc">+</span>Sigma,</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>global3,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch=</span><span class="dv">16</span>,<span class="at">cex=</span><span class="fl">0.5</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/scatter_plot3-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
<p>We can visualize the progress from run-levels 1 through 3 by plotting the estimates for each stage. The inset shows the upper 20 log likelihood units.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/stages_68d626488a21ac07f02321c5678aa0fc">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/stages-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>The maximum log likelihood discovered is -103.6, -103.6, an improvement of 0.7, 0.7 unit over the SIR model with the same values of <span class="math inline">\(\mu_{IR}\)</span> and <span class="math inline">\(k\)</span>. This small improvement is not by itself compelling evidence for the value of an extra parameter. However, the interpretation of the fitted model has some interesting features, which can be seen from the scatter plot matrix above.</p>
<p>We note that the trade-offs among <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\eta\)</span>, and <span class="math inline">\(\Rho\)</span> remain much the same as for the SIR model, suggesting that the model faces the same need to balance these parameters to explain the size and shape of the observed outbreak. However, it does appear that the data are more informative about the initial susceptible fraction <span class="math inline">\(\eta\)</span> as it appears in the SEIR model than they were about it in the SIR model. Moreover, the ML estimate of the reporting rate <span class="math inline">\(\Rho\)</span> (0.16, 0.16) for the SEIR is noticeably larger than it was in the SIR (0.056). Interestingly, the intermediate values of the ML estimates of <span class="math inline">\(\Rho\)</span> and <span class="math inline">\(\eta\)</span> are a closer match to epidemiological expectations for endemic measles in the pre-vaccine era, while remaining consistent with a mean infectious period of 0.5~wk, in contrast with the results in Section 5 of Lesson 4. Thus, it appears that adding a latent period to the model can substantively alter the interpretation of the fitted model without significantly changing the overall fit measured by maximized likelihood.</p>
<p>Profile likelihood calculations would help to clarify this finding. To get an initial indication of what such a profile might show, we can examine a “poor man’s profile” using the computations we’ve already performed. For example, the following shows the poor man’s profile over <span class="math inline">\(\Rho\)</span>. Consult <a href="./Q_fit_seir.R">the <strong>R</strong> script for this document</a> to see how it is computed.</p>
<div class="cell" data-layout-align="center" data-hash="tmp/Q_fit_seir/cache/poor_mans_profile_Rho_e2c37865a383cb39d8899b7741f0363f">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp/Q_fit_seir/figure/poor_mans_profile_Rho-1.png" class="img-fluid figure-img" width="2049"></p>
</figure>
</div>
</div>
</div>
<!---

One way to jump-start the profile calculation is to use our existing estimates.

::: {.cell layout-align="center" hash='tmp/Q_fit_seir/cache/profile_Rho_1a_dfc9fc9e8a814d70f675de497fe70e5f'}

```{.r .cell-code}
poorman_prof |>
  select(-loglik,-loglik.se) -> guesses
```

:::




By the same method as before, we estimate that this should require 1.4&nbsp;min on 15 processors.


::: {.cell layout-align="center" hash='tmp/Q_fit_seir/cache/profile_Rho_1_df0af7ddcb4ad24581979dfc9b07a676'}

```{.r .cell-code}
## Uncomment this code chunk to perform a profile computation
foreach(guess=iter(guesses,"row"), .combine=rbind,
  .options.future=list(seed=1270401374)
) %dofuture% {
  measSEIR |>
    mif2(
      Nmif=100, Np=2000,
      cooling.fraction.50=0.1,
      rw.sd=rw_sd(Beta=0.02, Eta=ivp(0.02), Sigma=0.05),
      params=c(unlist(guess),fixed_params)
    ) -> mf
  replicate(
    10,
    mf |> pfilter(Np=2000) |> logLik()
  ) |>
    logmeanexp(se=TRUE) -> ll
  mf |> coef() |> bind_rows() |>
    bind_cols(loglik=ll[1],loglik.se=ll[2])
} -> profile_Rho
```
:::



::: {.cell layout-align="center" hash='tmp/Q_fit_seir/cache/profile_Rho_1_plot_fe2e25aee2afe58b945d8c655f26d58e'}

```{.r .cell-code}
profile_Rho |>
  select(Sigma,loglik,Rho,Eta,Beta) |>
  pivot_longer(c(loglik,Eta,Sigma,Beta)) |>
  mutate(
    name=factor(name,levels=c("loglik","Eta","Sigma","Beta"))
  ) |>
  ggplot(aes(x=Rho,y=value))+
  geom_point()+
  labs(x=expression(rho),y="")+
  facet_wrap(~name,scales="free_y",ncol=1,strip.position="left")+
  theme(
    strip.placement="outside",
    strip.background=element_rect(fill=NA,color=NA)
  )
```

::: {.cell-output-display}
![](tmp/Q_fit_seir/figure/profile_Rho_1_plot-1.png){fig-align='center' fig-pos='h!' width=2049}
:::
:::


--->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>