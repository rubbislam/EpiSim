<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Qianying (Ruby) Lin">
<meta name="author" content="Spencer J. Fox">
<meta name="author" content="Zian (Larry) Zhuang">

<title>EpiSim - Lesson 4: Iterated filtering: principles and practice</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script>
MathJax = {
  loader: {
    load: ['[tex]/boldsymbol']
  },
  tex: {
    tags: "all",
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\\[','\\]']],
    processEscapes: true,
    processEnvironments: true,
    packages: {
      '[+]': ['boldsymbol']
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">EpiSim</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../instruction.html" rel="" target="">
 <span class="menu-text">Instruction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../introduction.html" rel="" target="">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../simulation.html" rel="" target="">
 <span class="menu-text">Simulation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../likelihood.html" rel="" target="">
 <span class="menu-text">Likelihood</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../iterated.html" rel="" target="">
 <span class="menu-text">Iterated filtering</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../case study.html" rel="" target="">
 <span class="menu-text">Case study</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#introduction-1" id="toc-introduction-1" class="nav-link" data-scroll-target="#introduction-1">Introduction</a></li>
  <li><a href="#objectives" id="toc-objectives" class="nav-link" data-scroll-target="#objectives">Objectives</a></li>
  </ul></li>
  <li><a href="#classification-of-statistical-methods-for-pomp-models" id="toc-classification-of-statistical-methods-for-pomp-models" class="nav-link" data-scroll-target="#classification-of-statistical-methods-for-pomp-models">Classification of statistical methods for POMP models</a>
  <ul class="collapse">
  <li><a href="#classification-of-statistical-methods-for-pomp-models-1" id="toc-classification-of-statistical-methods-for-pomp-models-1" class="nav-link" data-scroll-target="#classification-of-statistical-methods-for-pomp-models-1">Classification of statistical methods for POMP models</a></li>
  </ul></li>
  <li><a href="#the-plug-and-play-property" id="toc-the-plug-and-play-property" class="nav-link" data-scroll-target="#the-plug-and-play-property">The plug-and-play property</a>
  <ul class="collapse">
  <li><a href="#plug-and-play-also-called-simulation-based-methods" id="toc-plug-and-play-also-called-simulation-based-methods" class="nav-link" data-scroll-target="#plug-and-play-also-called-simulation-based-methods">Plug-and-play (also called simulation-based) methods</a></li>
  </ul></li>
  <li><a href="#full-information-vs.feature-based-methods" id="toc-full-information-vs.feature-based-methods" class="nav-link" data-scroll-target="#full-information-vs.feature-based-methods">Full information vs.~feature-based methods</a>
  <ul class="collapse">
  <li><a href="#full-information-and-feature-based-methods" id="toc-full-information-and-feature-based-methods" class="nav-link" data-scroll-target="#full-information-and-feature-based-methods">Full-information and feature-based methods</a></li>
  </ul></li>
  <li><a href="#bayesian-vs.frequentist-approaches" id="toc-bayesian-vs.frequentist-approaches" class="nav-link" data-scroll-target="#bayesian-vs.frequentist-approaches">Bayesian vs.~frequentist approaches</a>
  <ul class="collapse">
  <li><a href="#bayesian-and-frequentist-methods" id="toc-bayesian-and-frequentist-methods" class="nav-link" data-scroll-target="#bayesian-and-frequentist-methods">Bayesian and frequentist methods</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul></li>
  <li><a href="#iterated-filtering-in-theory" id="toc-iterated-filtering-in-theory" class="nav-link" data-scroll-target="#iterated-filtering-in-theory">Iterated filtering in theory</a>
  <ul class="collapse">
  <li><a href="#full-information-plug-and-play-frequentist-methods" id="toc-full-information-plug-and-play-frequentist-methods" class="nav-link" data-scroll-target="#full-information-plug-and-play-frequentist-methods">Full-information, plug-and-play, frequentist methods</a></li>
  <li><a href="#an-iterated-filtering-algorithm-if2" id="toc-an-iterated-filtering-algorithm-if2" class="nav-link" data-scroll-target="#an-iterated-filtering-algorithm-if2">An iterated filtering algorithm (IF2)</a></li>
  <li><a href="#if2-algorithm-pseudocode" id="toc-if2-algorithm-pseudocode" class="nav-link" data-scroll-target="#if2-algorithm-pseudocode">IF2 algorithm pseudocode</a></li>
  <li><a href="#analogy-with-evolution-by-natural-selection" id="toc-analogy-with-evolution-by-natural-selection" class="nav-link" data-scroll-target="#analogy-with-evolution-by-natural-selection">Analogy with evolution by natural selection</a></li>
  </ul></li>
  <li><a href="#iterated-filtering-in-practice" id="toc-iterated-filtering-in-practice" class="nav-link" data-scroll-target="#iterated-filtering-in-practice">Iterated filtering in practice</a></li>
  <li><a href="#an-example-problem" id="toc-an-example-problem" class="nav-link" data-scroll-target="#an-example-problem">An example problem</a>
  <ul class="collapse">
  <li><a href="#applying-if2-to-the-consett-measles-outbreak" id="toc-applying-if2-to-the-consett-measles-outbreak" class="nav-link" data-scroll-target="#applying-if2-to-the-consett-measles-outbreak">Applying IF2 to the Consett measles outbreak</a></li>
  </ul></li>
  <li><a href="#setting-up-the-estimation-problem" id="toc-setting-up-the-estimation-problem" class="nav-link" data-scroll-target="#setting-up-the-estimation-problem">Setting up the estimation problem</a>
  <ul class="collapse">
  <li><a href="#setting-up-the-estimation-problem-1" id="toc-setting-up-the-estimation-problem-1" class="nav-link" data-scroll-target="#setting-up-the-estimation-problem-1">Setting up the estimation problem</a></li>
  <li><a href="#sanity-check" id="toc-sanity-check" class="nav-link" data-scroll-target="#sanity-check">Sanity check</a></li>
  <li><a href="#parallel-computing" id="toc-parallel-computing" class="nav-link" data-scroll-target="#parallel-computing">Parallel computing</a></li>
  <li><a href="#running-a-particle-filter" id="toc-running-a-particle-filter" class="nav-link" data-scroll-target="#running-a-particle-filter">Running a particle filter</a></li>
  <li><a href="#building-up-a-picture-of-the-likelihood-surface" id="toc-building-up-a-picture-of-the-likelihood-surface" class="nav-link" data-scroll-target="#building-up-a-picture-of-the-likelihood-surface">Building up a picture of the likelihood surface</a></li>
  </ul></li>
  <li><a href="#a-local-search-of-the-likelihood-surface" id="toc-a-local-search-of-the-likelihood-surface" class="nav-link" data-scroll-target="#a-local-search-of-the-likelihood-surface">A local search of the likelihood surface</a>
  <ul class="collapse">
  <li><a href="#a-local-search-of-the-likelihood-surface-1" id="toc-a-local-search-of-the-likelihood-surface-1" class="nav-link" data-scroll-target="#a-local-search-of-the-likelihood-surface-1">A local search of the likelihood surface</a></li>
  <li><a href="#windows-issues" id="toc-windows-issues" class="nav-link" data-scroll-target="#windows-issues">Windows issues</a></li>
  <li><a href="#iterated-filtering-diagnostics" id="toc-iterated-filtering-diagnostics" class="nav-link" data-scroll-target="#iterated-filtering-diagnostics">Iterated filtering diagnostics</a></li>
  <li><a href="#estimating-the-likelihood" id="toc-estimating-the-likelihood" class="nav-link" data-scroll-target="#estimating-the-likelihood">Estimating the likelihood</a></li>
  <li><a href="#building-up-a-picture-of-the-likelihood-surface-1" id="toc-building-up-a-picture-of-the-likelihood-surface-1" class="nav-link" data-scroll-target="#building-up-a-picture-of-the-likelihood-surface-1">Building up a picture of the likelihood surface</a></li>
  </ul></li>
  <li><a href="#searching-for-the-mle" id="toc-searching-for-the-mle" class="nav-link" data-scroll-target="#searching-for-the-mle">Searching for the MLE</a></li>
  <li><a href="#a-global-search" id="toc-a-global-search" class="nav-link" data-scroll-target="#a-global-search">A global search</a>
  <ul class="collapse">
  <li><a href="#a-global-search-of-the-likelihood-surface" id="toc-a-global-search-of-the-likelihood-surface" class="nav-link" data-scroll-target="#a-global-search-of-the-likelihood-surface">A global search of the likelihood surface</a></li>
  </ul></li>
  <li><a href="#profile-likelihood" id="toc-profile-likelihood" class="nav-link" data-scroll-target="#profile-likelihood">Profile likelihood</a>
  <ul class="collapse">
  <li><a href="#profile-likelihood-over-eta" id="toc-profile-likelihood-over-eta" class="nav-link" data-scroll-target="#profile-likelihood-over-eta">Profile likelihood over <span class="math inline">\(\eta\)</span></a></li>
  <li><a href="#visualizing-profile-likelihood" id="toc-visualizing-profile-likelihood" class="nav-link" data-scroll-target="#visualizing-profile-likelihood">Visualizing profile likelihood</a></li>
  <li><a href="#profile-over-rho" id="toc-profile-over-rho" class="nav-link" data-scroll-target="#profile-over-rho">Profile over <span class="math inline">\(\rho\)</span></a></li>
  <li><a href="#profile-over-rho-results" id="toc-profile-over-rho-results" class="nav-link" data-scroll-target="#profile-over-rho-results">Profile over <span class="math inline">\(\rho\)</span>: results</a></li>
  <li><a href="#the-investigation-continues." id="toc-the-investigation-continues." class="nav-link" data-scroll-target="#the-investigation-continues.">The investigation continues.</a></li>
  </ul></li>
  <li><a href="#making-predictions" id="toc-making-predictions" class="nav-link" data-scroll-target="#making-predictions">Making predictions</a>
  <ul class="collapse">
  <li><a href="#parameter-estimates-as-model-predictions" id="toc-parameter-estimates-as-model-predictions" class="nav-link" data-scroll-target="#parameter-estimates-as-model-predictions">Parameter estimates as model predictions</a></li>
  </ul></li>
  <li><a href="#searching-in-another-direction" id="toc-searching-in-another-direction" class="nav-link" data-scroll-target="#searching-in-another-direction">Searching in another direction</a>
  <ul class="collapse">
  <li><a href="#another-global-search" id="toc-another-global-search" class="nav-link" data-scroll-target="#another-global-search">Another global search</a></li>
  <li><a href="#profile-over-infectious-period" id="toc-profile-over-infectious-period" class="nav-link" data-scroll-target="#profile-over-infectious-period">Profile over infectious period</a></li>
  <li><a href="#infectious-period-profile" id="toc-infectious-period-profile" class="nav-link" data-scroll-target="#infectious-period-profile">Infectious period profile</a></li>
  <li><a href="#visualizing-predictions" id="toc-visualizing-predictions" class="nav-link" data-scroll-target="#visualizing-predictions">Visualizing predictions</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a>
  <ul class="collapse">
  <li><a href="#fitting-the-seir-model" id="toc-fitting-the-seir-model" class="nav-link" data-scroll-target="#fitting-the-seir-model">Fitting the SEIR model</a></li>
  <li><a href="#fitting-all-parameters-of-the-sir-model" id="toc-fitting-all-parameters-of-the-sir-model" class="nav-link" data-scroll-target="#fitting-all-parameters-of-the-sir-model">Fitting all parameters of the SIR model</a></li>
  <li><a href="#construct-a-profile-likelihood" id="toc-construct-a-profile-likelihood" class="nav-link" data-scroll-target="#construct-a-profile-likelihood">Construct a profile likelihood</a></li>
  <li><a href="#checking-the-source-code" id="toc-checking-the-source-code" class="nav-link" data-scroll-target="#checking-the-source-code">Checking the source code</a></li>
  <li><a href="#beware-errors-in-rprocess" id="toc-beware-errors-in-rprocess" class="nav-link" data-scroll-target="#beware-errors-in-rprocess">Beware errors in <code>rprocess</code></a></li>
  <li><a href="#choosing-the-algorithmic-settings-for-if2" id="toc-choosing-the-algorithmic-settings-for-if2" class="nav-link" data-scroll-target="#choosing-the-algorithmic-settings-for-if2">Choosing the algorithmic settings for IF2</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a>
  <ul class="collapse">
  <li><a href="#references-1" id="toc-references-1" class="nav-link" data-scroll-target="#references-1">References</a></li>
  <li><a href="#license-acknowledgments-and-links" id="toc-license-acknowledgments-and-links" class="nav-link" data-scroll-target="#license-acknowledgments-and-links">License, acknowledgments, and links</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="main.pdf"><i class="bi bi-file-pdf"></i>Beamer</a></li><li><a href="main.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lesson 4: Iterated filtering: principles and practice</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Qianying (Ruby) Lin </p>
             <p>Spencer J. Fox </p>
             <p>Zian (Larry) Zhuang </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<section id="introduction-1" class="level2">
<h2 class="anchored" data-anchor-id="introduction-1">Introduction</h2>
<ul>
<li>This tutorial covers likelihood estimation via the method of iterated filtering.</li>
<li>It presupposes familiarity with building partially observed Markov process (POMP) objects in the <code>R</code> package pomp <span class="citation" data-cites="King2016">(<a href="#ref-King2016" role="doc-biblioref">King, Nguyen, and Ionides 2016</a>)</span>.</li>
<li>This tutorial follows on from the <a href="../pfilter/main.pdf">topic of particle filtering</a> (also known as sequential Monte Carlo) via <code>pfilter</code> in pomp.</li>
</ul>
</section>
<section id="objectives" class="level2">
<h2 class="anchored" data-anchor-id="objectives">Objectives</h2>
<ol type="1">
<li>To review the available options for inference on POMP models, to put iterated filtering in context.</li>
<li>To understand how iterated filtering algorithms carry out repeated particle filtering operations, with randomly perturbed parameter values, in order to maximize the likelihood.</li>
<li>To gain experience carrying out statistical investigations using iterated filtering in a relatively simple situation: fitting an SIR model to data from a measles outbreak.</li>
</ol>
</section>
</section>
<section id="classification-of-statistical-methods-for-pomp-models" class="level1">
<h1>Classification of statistical methods for POMP models</h1>
<section id="classification-of-statistical-methods-for-pomp-models-1" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="classification-of-statistical-methods-for-pomp-models-1">Classification of statistical methods for POMP models</h2>
<ul>
<li><p>Many, many statistical methods have been proposed for inference on POMP models <span class="citation" data-cites="He2010">King, Nguyen, and Ionides (<a href="#ref-King2016" role="doc-biblioref">2016</a>)</span>.</p></li>
<li><p>The volume of research indicates both the importance and the difficulty of the problem.</p></li>
<li><p>Let’s start by considering three criteria to categorize inference methods:</p>
<ul>
<li>the plug-and-play property</li>
<li>full-information or feature-based</li>
<li>frequentist or Bayesian</li>
</ul></li>
</ul>
</section>
</section>
<section id="the-plug-and-play-property" class="level1">
<h1>The plug-and-play property</h1>
<section id="plug-and-play-also-called-simulation-based-methods" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="plug-and-play-also-called-simulation-based-methods">Plug-and-play (also called simulation-based) methods</h2>
<ul>
<li>Inference methodology that calls <code>rprocess</code> but not <code>dprocess</code> is said to be <em>plug-and-play</em>. All popular modern Monte Carlo methods for POMP models are in this category.</li>
<li>“Simulation-based” is equivalent to “plug-and-play”.</li>
<li>Historically, simulation-based meant simulating forward from initial conditions to the end of the time series.</li>
<li>However, particle filtering methods instead consider each observation interval sequentially. They carry out multiple, carefully selected, simulations over each interval.</li>
</ul>
<ul>
<li>Plug-and-play methods can call <code>dmeasure</code>. A method that uses only <code>rprocess</code> and <code>rmeasure</code> is called “doubly plug-and-play”.</li>
<li>Two <em>non-plug-and-play</em> methods—expectation-maximization (EM) and Markov chain Monte Carlo (MCMC)—have theoretical convergence problems for nonlinear POMP models. The failures of these two workhorses of statistical computation have prompted development of alternative methodologies.</li>
</ul>
</section>
</section>
<section id="full-information-vs.feature-based-methods" class="level1">
<h1>Full information vs.~feature-based methods</h1>
<section id="full-information-and-feature-based-methods" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="full-information-and-feature-based-methods">Full-information and feature-based methods</h2>
<ul>
<li><em>Full-information</em> methods are defined to be those based on the likelihood function for the full data (i.e., likelihood-based frequentist inference and Bayesian inference).</li>
<li><em>Feature-based</em> methods either consider a summary statistic (a function of the data) or work with an an alternative to the likelihood.</li>
<li>Asymptotically, full-information methods are statistically efficient and feature-based methods are not.</li>
<li>In some cases, loss of statistical efficiency might be an acceptable tradeoff for advantages in computational efficiency.</li>
</ul>
<ul>
<li><p>However:</p>
<ul>
<li>Good low-dimensional summary statistics can be hard to find.</li>
<li>When using statistically inefficient methods, it can be hard to know how much information you are losing.</li>
<li>Intuition and scientific reasoning can be inadequate tools to derive informative low-dimensional summary statistics <span class="citation" data-cites="Shrestha2011">(<a href="#ref-Shrestha2011" role="doc-biblioref">Shrestha, King, and Rohani 2011, Ionides2011a</a>)</span>.</li>
</ul></li>
</ul>
</section>
</section>
<section id="bayesian-vs.frequentist-approaches" class="level1">
<h1>Bayesian vs.~frequentist approaches</h1>
<section id="bayesian-and-frequentist-methods" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="bayesian-and-frequentist-methods">Bayesian and frequentist methods</h2>
<ul>
<li><p>Recently, plug-and-play Bayesian methods have been discovered:</p>
<ul>
<li>particle Markov chain Monte Carlo (PMCMC) <span class="citation" data-cites="Andrieu2010">(<a href="#ref-Andrieu2010" role="doc-biblioref">Andrieu, Doucet, and Holenstein 2010</a>)</span>.</li>
<li>approximate Bayesian computation (ABC) <span class="citation" data-cites="Toni2009">(<a href="#ref-Toni2009" role="doc-biblioref">Toni et al. 2009</a>)</span>.</li>
</ul></li>
<li><p>Prior belief specification is both the strength and weakness of Bayesian methodology:</p></li>
<li><p>The likelihood surface for nonlinear POMP models often contains nonlinear ridges and variations in curvature.</p></li>
</ul>
<ul>
<li>These situations bring into question the appropriateness of independent priors derived from expert opinion on marginal distributions of parameters.</li>
<li>They also are problematic for specification of “flat” or “uninformative” prior beliefs.</li>
<li>Expert opinion can be treated as data for non-Bayesian analysis. However, our primary task is to identify the information in the data under investigation, so it can be helpful to use methods that do not force us to make our conclusions dependent on quantification of prior beliefs.</li>
</ul>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>

</section>
</section>
<section id="iterated-filtering-in-theory" class="level1">
<h1>Iterated filtering in theory</h1>
<section id="full-information-plug-and-play-frequentist-methods" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="full-information-plug-and-play-frequentist-methods">Full-information, plug-and-play, frequentist methods</h2>
<ul>
<li>Iterated filtering methods <span class="citation" data-cites="Ionides2006">Edward L. Ionides et al. (<a href="#ref-Ionides2015" role="doc-biblioref">2015</a>)</span> are the only currently available, full-information, plug-and-play, frequentist methods for POMP models.</li>
<li>Iterated filtering methods have been shown to solve likelihood-based inference problems for epidemiological situations which are computationally intractable for available Bayesian methodology <span class="citation" data-cites="Ionides2015">(<a href="#ref-Ionides2015" role="doc-biblioref">Edward L. Ionides et al. 2015</a>)</span>.</li>
</ul>
</section>
<section id="an-iterated-filtering-algorithm-if2" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="an-iterated-filtering-algorithm-if2">An iterated filtering algorithm (IF2)</h2>
<p>We focus on the IF2 algorithm of <span class="citation" data-cites="Ionides2015">Edward L. Ionides et al. (<a href="#ref-Ionides2015" role="doc-biblioref">2015</a>)</span>. In this algorithm:</p>
<ul>
<li>Each iteration consists of a particle filter, carried out with the parameter vector, for each particle, doing a random walk.</li>
<li>At the end of the time series, the collection of parameter vectors is recycled as starting parameters for the next iteration.</li>
<li>The random-walk variance decreases at each iteration.</li>
</ul>
<p>In theory, this procedure converges toward the region of parameter space maximizing the maximum likelihood.<br>
In practice, we can test this claim on examples.</p>
</section>
<section id="if2-algorithm-pseudocode" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="if2-algorithm-pseudocode">IF2 algorithm pseudocode</h2>
<p><strong>Input:</strong></p>
<ul>
<li>simulators for <span class="math inline">\(f_{X_0}(x_0;\theta)\)</span> and <span class="math inline">\(f_{X_n|X_{n-1}}(x_n| x_{n-1}; \theta)\)</span>\</li>
<li>evaluator for <span class="math inline">\(f_{Y_n|X_n}(y_n| x_n;\theta)\)</span>\</li>
<li>data, <span class="math inline">\(y^*_{1:N}\)</span>\</li>
</ul>
<p></p>
<ul>
<li>number of iterations, {mif = }<span class="math inline">\(M\)</span>\</li>
<li>number of particles, {p = }<span class="math inline">\(J\)</span>\</li>
<li>initial parameter swarm, {arams = }<span class="math inline">\(\{\Theta^0_j, j=1,\dots,J\}\)</span>\</li>
<li>random walk standard deviation for each parameter, {w.sd}, squared to construct a diagonal variance matrix, <span class="math inline">\(V_n\)</span>\</li>
<li>cooling fraction in 50 iterations, <span class="math inline">\(a\)</span>\</li>
</ul>
<p><strong>Output:</strong></p>
<ul>
<li>final parameter swarm, <span class="math inline">\(\{\Theta^M_j, j=1,\dots,J\}\)</span>\</li>
</ul>
<p><strong>Procedure:</strong></p>
<ol type="1">
<li>For <span class="math inline">\(m\)</span> in <span class="math inline">\(1{:}M\)</span></li>
<li><span class="math inline">\(\qquad\)</span> <span class="math inline">\(\Theta^{F,m}_{0,j}\sim \normal\big(\Theta^{m-1}_{j},V_0 \, a^{2m/50}\big)\)</span> for <span class="math inline">\(j\)</span> in <span class="math inline">\(1{:} J\)</span></li>
<li><span class="math inline">\(\qquad\)</span> <span class="math inline">\(X_{0,j}^{F,m}\sim f_{X_0}(x_0 ; \Theta^{F,m}_{0,j})\)</span> for <span class="math inline">\(j\)</span> in <span class="math inline">\(1{:} J\)</span></li>
<li><span class="math inline">\(\qquad\)</span> For <span class="math inline">\(n\)</span> in <span class="math inline">\(1{:} N\)</span></li>
<li><span class="math inline">\(\qquad\qquad\)</span> <span class="math inline">\(\Theta^{P,m}_{n,j}\sim \normal\big(\Theta^{F,m}_{n-1,j},V_n \, a^{2m/50}\big)\)</span> for <span class="math inline">\(j\)</span> in <span class="math inline">\(1{:} J\)</span></li>
<li><span class="math inline">\(\qquad\qquad\)</span> <span class="math inline">\(X_{n,j}^{P,m}\sim f_{X_n|X_{n-1}}(x_n | X^{F,m}_{n-1,j}; \Theta^{P,m}_{n,j})\)</span> for <span class="math inline">\(j\)</span> in <span class="math inline">\(1{:} J\)</span></li>
<li><span class="math inline">\(\qquad\qquad\)</span> <span class="math inline">\(w_{n,j}^m = f_{Y_n|X_n}(y^*_n| X_{n,j}^{P,m} ; \Theta^{P,m}_{n,j})\)</span> for <span class="math inline">\(j\)</span> in <span class="math inline">\(1{:} J\)</span></li>
<li><span class="math inline">\(\qquad\qquad\)</span> Draw <span class="math inline">\(k_{1{:}J}\)</span> with <span class="math inline">\(P[k_j=i]= w_{n,i}^m\Big/\sum_{u=1}^J w_{n,u}^m\)</span></li>
<li><span class="math inline">\(\qquad\qquad\)</span> <span class="math inline">\(\Theta^{F,m}_{n,j}=\Theta^{P,m}_{n,k_j}\)</span> and <span class="math inline">\(X^{F,m}_{n,j}=X^{P,m}_{n,k_j}\)</span> for <span class="math inline">\(j\)</span> in <span class="math inline">\(1{:} J\)</span></li>
<li><span class="math inline">\(\qquad\)</span> End For</li>
<li><span class="math inline">\(\qquad\)</span> Set <span class="math inline">\(\Theta^{m}_{j}=\Theta^{F,m}_{N,j}\)</span> for <span class="math inline">\(j\)</span> in <span class="math inline">\(1{:} J\)</span></li>
<li>End For</li>
</ol>
<p><strong>Remarks:</strong></p>
<ul>
<li>The <span class="math inline">\(N\)</span> loop (lines 4 through 10) is a basic particle filter applied to a model with stochastic perturbations to the parameters.</li>
<li>The <span class="math inline">\(M\)</span> loop repeats this particle filter with decreasing perturbations.</li>
<li>The superscript <span class="math inline">\(F\)</span> in <span class="math inline">\(\Theta^{F,m}_{n,j}\)</span> and <span class="math inline">\(X^{F,m}_{n,j}\)</span> denote solutions to the <em>filtering problem</em>, with the particles <span class="math inline">\(j=1,\dots,J\)</span> providing a Monte Carlo representation of the conditional distribution at time <span class="math inline">\(n\)</span> given data <span class="math inline">\(y^*_{1:n}\)</span> for filtering iteration <span class="math inline">\(m\)</span>.</li>
<li>The superscript <span class="math inline">\(P\)</span> in <span class="math inline">\(\Theta^{P,m}_{n,j}\)</span> and <span class="math inline">\(X^{P,m}_{n,j}\)</span> denote solutions to the <em>prediction problem</em>, with the particles <span class="math inline">\(j=1,\dots,J\)</span> providing a Monte Carlo representation of the conditional distribution at time <span class="math inline">\(n\)</span> given data <span class="math inline">\(y^*_{1:n-1}\)</span> for filtering iteration <span class="math inline">\(m\)</span>.</li>
<li>The <em>weight</em> <span class="math inline">\(w^m_{n,j}\)</span> gives the likelihood of the data at time <span class="math inline">\(n\)</span> for particle <span class="math inline">\(j\)</span> in filtering iteration <span class="math inline">\(m\)</span>.</li>
</ul>
</section>
<section id="analogy-with-evolution-by-natural-selection" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="analogy-with-evolution-by-natural-selection">Analogy with evolution by natural selection</h2>
<ul>
<li>The parameters characterize the <em>genotype</em>.</li>
<li>The swarm of particles is a <em>population</em>.</li>
<li>The likelihood, a measure of the compatibility between the parameters and the data, is the analogue of <em>fitness</em>.</li>
<li>Each successive observation is a new <em>generation</em>.</li>
<li>Since particles reproduce in each generation in proportion to their likelihood, the particle filter acts like <em>natural selection</em>.</li>
<li>The artificial perturbations augment the “genetic” variance and therefore correspond to <em>mutation</em>.</li>
<li>IF2 increases the <em>fitness</em> of the population of particles.</li>
<li>However, because our scientific interest focuses on the model without the artificial perturbations, we decrease the intensity of the latter with successive iterations.</li>
</ul>
</section>
</section>
<section id="iterated-filtering-in-practice" class="level1">
<h1>Iterated filtering in practice</h1>
</section>
<section id="an-example-problem" class="level1">
<h1>An example problem</h1>
<section id="applying-if2-to-the-consett-measles-outbreak" class="level2">
<h2 class="anchored" data-anchor-id="applying-if2-to-the-consett-measles-outbreak">Applying IF2 to the Consett measles outbreak</h2>
<p>Let us apply IF2 to our analysis of the Consett measles outbreak we began to examine in Lessons 2 and 3.</p>
<p>The following loads the data, pomp, and the stochastic SIR model we constructed there.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/model-construct_ae260fe823363a805f7bd0e8c665c3b6">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"model_measSIR.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/dataplot_b0c7cde8090f16fbf7d303e063e5a89f">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/dataplot-1.png" style="height:70.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<!-- ```{r dataplot,purl=FALSE,echo=FALSE,dpi=200,out.width="0.7\\textwidth"} -->
<!-- op <- par(mar=c(3,3,0.5,0.5)) -->
<!-- measSIR |> plot() -->
<!-- par(op) -->
<!-- ``` -->
<!-- In the earlier lessons, we demonstrated how to test the codes via simulation. -->
<!-- ## Testing the codes: filtering  {.allowframebreaks} -->
<!-- Before engaging in iterated filtering, it is a good idea to check that the basic particle filter is working since we can't iterate something unless we can run it once! -->
<!-- The simulations above check the `rprocess` and `rmeasure` codes; -->
<!-- the particle filter depends on the `rprocess` and `dmeasure` codes and so is a check of the latter. -->
<!-- ```{r init_pfilter} -->
<!-- measSIR |> -->
<!--   pfilter(Np=1000) -> pf -->
<!-- ``` -->
<!-- ```{r init_pfilter_plot,purl=F,dpi=200,out.width="0.7\\textwidth"} -->
<!-- plot(pf) -->
<!-- ``` -->
<!-- \vspace{-5mm} -->
<!-- The above plot shows the data (`reports`), along with the *effective sample size* (ESS) of the particle filter (`ess`) and the log-likelihood of each observation conditional on the preceding ones (`cond.logLik`). -->
<!-- The ESS is the equivalent number of independent particles. -->
<!-- In this case, the ESS appears to be everywhere adequate. -->
</section>
</section>
<section id="setting-up-the-estimation-problem" class="level1">
<h1>Setting up the estimation problem</h1>
<section id="setting-up-the-estimation-problem-1" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-estimation-problem-1">Setting up the estimation problem</h2>
<p>Let’s assume that the population size, <span class="math inline">\(N\)</span>, is known accurately. We’ll fix that parameter.</p>
<p>Let’s revisit the assumption that the infectious period is 2 weeks, imagining that we have access to the results of household and clinical studies that have concluded that infected patients shed the virus for 3–4~da. We’ll use these results to constrain the infectious period in our model to 3.5~da, i.e., <span class="math inline">\(\gamma=2~\mathrm{wk}^{-1}\)</span>. We also fix <span class="math inline">\(k=10\)</span>. Later, we can relax our assumptions.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/fixed_params_e7b756c0ef840b488de489fbca8e2420">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>fixed_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">N=</span><span class="dv">38000</span>, <span class="at">Gamma=</span><span class="dv">2</span>, <span class="at">k=</span><span class="dv">10</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(measSIR,<span class="fu">names</span>(fixed_params)) <span class="ot">&lt;-</span> fixed_params</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(measSIR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Beta   Gamma     Rho       k     Eta       N 
1.5e+01 2.0e+00 5.0e-01 1.0e+01 6.0e-02 3.8e+04 </code></pre>
</div>
</div>
<p>We proceed to estimate <span class="math inline">\(\beta\)</span>, <span class="math inline">\(\eta\)</span>, and <span class="math inline">\(\rho\)</span>.</p>
</section>
<section id="sanity-check" class="level2">
<h2 class="anchored" data-anchor-id="sanity-check">Sanity check</h2>
<p>In Lesson 3, we have introduced how to test the codes and the particle filter from three aspects. Now we can compare the simulations with the raw data using the proposed parameters:</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/sanity_0ded17f681fa619c6e049b567512ea1a">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/sanity-1.png" style="height:70.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="parallel-computing" class="level2">
<h2 class="anchored" data-anchor-id="parallel-computing">Parallel computing</h2>
<p>It will be helpful to parallelize most of the computations. <a href="https://kingaa.github.io/sbied/pfilter/">Lesson 3</a> discusses how to accomplish this using foreach.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="running-a-particle-filter" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="running-a-particle-filter">Running a particle filter</h2>
<p>We proceed to carry out replicated particle filters at an initial guess of <span class="math inline">\(\beta=15\)</span>, <span class="math inline">\(\eta=0.06\)</span>, and <span class="math inline">\(\rho=0.5\)</span>.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/pf2_5d6969224095aacd4ea1a1304fb2c0dd">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,<span class="at">.combine=</span>c,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="cn">TRUE</span>)) <span class="sc">%dofuture%</span> {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  measSIR <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">5000</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> pf</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>pf <span class="sc">|&gt;</span> <span class="fu">logLik</span>() <span class="sc">|&gt;</span> <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> L_pf</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>L_pf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/pf_5d8156810740e2f587c5644a9d743c77">
<div class="cell-output cell-output-stdout">
<pre><code>         est           se 
-274.2571683    0.8639223 </code></pre>
</div>
</div>
<p>In 3.28 seconds, using 10 cores, we obtain an unbiased likelihood estimate of -274.3 with a Monte Carlo standard error of 0.86.</p>
</section>
<section id="building-up-a-picture-of-the-likelihood-surface" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="building-up-a-picture-of-the-likelihood-surface">Building up a picture of the likelihood surface</h2>
<ul>
<li>Given a model and a set of data, the likelihood surface is well defined, though it may be difficult to visualize.</li>
<li>We can develop a progressively more complete picture of this surface by storing likelihood estimates whenever we compute them.</li>
<li>It is a very good idea to set up a database within which to store the likelihood of every point for which we have an estimated likelihood.</li>
<li>This will become larger and more complete as our parameter-space search goes on and will be a basis for a variety of explorations.</li>
</ul>
<p>At this point, we’ve computed the likelihood at a single point. Let’s store this point, together with the estimated likelihood and our estimate of the standard error on that likelihood, in a CSV file:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pf[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="at">loglik=</span>L_pf[<span class="dv">1</span>],<span class="at">loglik.se=</span>L_pf[<span class="dv">2</span>]) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"measles_params.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="a-local-search-of-the-likelihood-surface" class="level1">
<h1>A local search of the likelihood surface</h1>
<section id="a-local-search-of-the-likelihood-surface-1" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="a-local-search-of-the-likelihood-surface-1">A local search of the likelihood surface</h2>
<p>Let’s carry out a local search using <code>mif2</code> around this point in parameter space.</p>
<ul>
<li>We need to choose the <code>rw.sd</code> and <code>cooling.fraction.50</code> algorithmic parameters.</li>
<li>Since <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> will be estimated on the log scale, and we expect that multiplicative perturbations of these parameters will have roughly similar effects on the likelihood, we’ll use a perturbation size of <span class="math inline">\(0.02\)</span>, which we imagine will have a small but non-negligible effect.</li>
<li>For simplicity, we’ll use the same perturbation size on <span class="math inline">\(\rho\)</span>.</li>
<li>We fix <code>cooling.fraction.50=0.5</code>, so that after 50 <code>mif2</code> iterations, the perturbations are reduced to half their original magnitudes.</li>
</ul>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/local_search_07ab3d655632d9bc7a755ba2c2a3113a">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,<span class="at">.combine=</span>c,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">482947940</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dofuture%</span> {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  measSIR <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">Np=</span><span class="dv">2000</span>, <span class="at">Nmif=</span><span class="dv">50</span>, <span class="at">cooling.fraction.50=</span><span class="fl">0.5</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>, <span class="at">Rho=</span><span class="fl">0.02</span>, <span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>)),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">partrans=</span><span class="fu">parameter_trans</span>(</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">log=</span><span class="st">"Beta"</span>,<span class="at">logit=</span><span class="fu">c</span>(<span class="st">"Rho"</span>,<span class="st">"Eta"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">paramnames=</span><span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Rho"</span>,<span class="st">"Eta"</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> mifs_local</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="windows-issues" class="level2">
<h2 class="anchored" data-anchor-id="windows-issues">Windows issues</h2>
<p>Some Windows users have reported trouble with the above code. This appears to be due to certain Windows security features that make it impossible to compile codes inside a parallel block. We have found a workaround.</p>
<ul>
<li><a href="../misc/windows.html">This document describes the problem and the workaround.</a></li>
<li><a href="./main_win.R">A Windows-safe version of the code for this document is available here.</a></li>
</ul>
</section>
<section id="iterated-filtering-diagnostics" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="iterated-filtering-diagnostics">Iterated filtering diagnostics</h2>
<p>We obtain some diagnostic plots with the <code>plot</code> command applied to <code>mifs_local</code>. Here is a way to get a prettier version:</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/local_search_plot_e8e15f30dd944ba892e4609a3bb57f04">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mifs_local <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">traces</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">melt</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>iteration,<span class="at">y=</span>value,<span class="at">group=</span>.L1,<span class="at">color=</span><span class="fu">factor</span>(.L1)))<span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>name,<span class="at">scales=</span><span class="st">"free_y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/local_search_plot-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li><p>We see that the likelihood increases as the iterations proceed, though there is considerable variability due to</p>
<ol type="1">
<li>the poorness of our starting guess and</li>
<li>the stochastic nature of this Monte Carlo algorithm.</li>
</ol></li>
<li><p>We see movement in the parameters, though variability remains.</p></li>
</ul>
</section>
<section id="estimating-the-likelihood" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="estimating-the-likelihood">Estimating the likelihood</h2>
<p>Although the filtering carried out by <code>mif2</code> in the final filtering iteration generates an approximation to the likelihood at the resulting point estimate, this is not good enough for reliable inference.</p>
<ul>
<li>Partly, this is because parameter perturbations are applied in the last filtering iteration, so that the likelihood reported by <code>mif2</code> is not identical to that of the model of interest.</li>
<li>Partly, this is because <code>mif2</code> is usually carried out with fewer particles than are needed for a good likelihood evaluation.</li>
</ul>
<p>Therefore, we evaluate the likelihood, together with a standard error, using replicated particle filters at each point estimate.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/lik_local_b2496e4cf0134026a00b854eaecfaa6d">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">mf=</span>mifs_local,<span class="at">.combine=</span>rbind,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">900242057</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dofuture%</span> {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  evals <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">10</span>, <span class="fu">logLik</span>(<span class="fu">pfilter</span>(mf,<span class="at">Np=</span><span class="dv">5000</span>)))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  ll <span class="ot">&lt;-</span> <span class="fu">logmeanexp</span>(evals,<span class="at">se=</span><span class="cn">TRUE</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On 10 processors, this local investigation took 14~sec for the maximization and 5~sec for the likelihood evaluation.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/mle_local_2be203242bc1fbd41ca1e3bf257e206e">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> <span class="fu">filter</span>(loglik<span class="sc">==</span><span class="fu">max</span>(loglik))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
   Beta Gamma   Rho     k    Eta     N loglik loglik.se
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
1  26.0     2 0.304    10 0.0904 38000  -112.    0.0630</code></pre>
</div>
</div>
<p>These repeated stochastic maximizations can also show us the geometry of the likelihood surface in a neighborhood of this point estimate:</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/pairs_local_cd7b5daccc1682a960ab75b171689573">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(<span class="sc">~</span>loglik<span class="sc">+</span>Beta<span class="sc">+</span>Eta<span class="sc">+</span>Rho,<span class="at">data=</span>results,<span class="at">pch=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/pairs_local-1.png" style="height:80.0%" width="2400" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="building-up-a-picture-of-the-likelihood-surface-1" class="level2">
<h2 class="anchored" data-anchor-id="building-up-a-picture-of-the-likelihood-surface-1">Building up a picture of the likelihood surface</h2>
<p>This plot shows a hint of a ridge in the likelihood surface (cf.~the <span class="math inline">\(\beta\)</span>-<span class="math inline">\(\eta\)</span> panel). However, the sampling is as yet too sparse to give a clear picture.</p>
<p>We add these newly explored points to our database,</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(results) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>loglik) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"measles_params.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and move on to a more thorough exploration of the likelihood surface.</p>
</section>
</section>
<section id="searching-for-the-mle" class="level1">
<h1>Searching for the MLE</h1>
</section>
<section id="a-global-search" class="level1">
<h1>A global search</h1>
<section id="a-global-search-of-the-likelihood-surface" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="a-global-search-of-the-likelihood-surface">A global search of the likelihood surface</h2>
<ul>
<li><p>When carrying out parameter estimation for dynamic systems, we need to specify beginning values for both the dynamic system (in the state space) and the parameters (in the parameter space).</p></li>
<li><p>To avoid confusion, we use the term “initial values” to refer to the state of the system at <span class="math inline">\(t_0\)</span> and “starting values” to refer to the point in parameter space at which a search is initialized.</p></li>
<li><p>Practical parameter estimation involves trying many starting values for the parameters.</p></li>
<li><p>One way to approach this is to choose a large box in parameter space that contains all remotely sensible parameter vectors.</p></li>
<li><p>If an estimation method gives stable conclusions with starting values drawn randomly from this box, this gives some confidence that an adequate global search has been carried out.</p></li>
</ul>
<p>For our measles model, a box containing reasonable parameter values might be <span class="math inline">\(\beta\in (5,80)\)</span>, <span class="math inline">\(\rho\in (0.2,0.9)\)</span>, <span class="math inline">\(\eta\in (0,1)\)</span>.</p>
<p>We are now ready to carry out likelihood maximizations from diverse starting points.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/global_search1_35299af033333a03ce6fc1c26cdb9291">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2062379496</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">runif_design</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">5</span>,<span class="at">Rho=</span><span class="fl">0.2</span>,<span class="at">Eta=</span><span class="dv">0</span>),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">80</span>,<span class="at">Rho=</span><span class="fl">0.9</span>,<span class="at">Eta=</span><span class="dv">1</span>),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">nseq=</span><span class="dv">400</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>) <span class="ot">-&gt;</span> guesses</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>mf1 <span class="ot">&lt;-</span> mifs_local[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/global_search2_a06c59bfbd1bd0e0fd9e1b249cd5f6a8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">guess=</span><span class="fu">iter</span>(guesses,<span class="st">"row"</span>), <span class="at">.combine=</span>rbind,</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">1270401374</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dofuture%</span> {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  mf1 <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">params=</span><span class="fu">c</span>(guess,fixed_params)) <span class="sc">|&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">Nmif=</span><span class="dv">100</span>) <span class="ot">-&gt;</span> mf</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    mf <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">5000</span>) <span class="sc">|&gt;</span> <span class="fu">logLik</span>()</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ll</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>The above codes run one search from each of 400 starting values.</p></li>
<li><p>Each search consists of an initial run of 50 IF2 iterations, followed by another 100 iterations.</p></li>
<li><p>These codes exhibit a general pomp behavior:</p>
<ul>
<li>Re-running a command on an object (i.e., <code>mif2</code> on <code>mf1</code>) created by the same command preserves the algorithmic arguments.</li>
<li>In particular, running <code>mif2</code> on the result of a <code>mif2</code> computation re-runs IF2 from the endpoint of the first run.</li>
<li>In the second computation, by default, all algorithmic parameters are preserved; here we overrode the default choice of <code>Nmif</code>.</li>
</ul></li>
<li><p>Following the <code>mif2</code> computations, the particle filter is used to evaluate the likelihood, as before.</p></li>
</ul>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/mle_global_9e292da2f01d982361a75bb99cbae547">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> <span class="fu">filter</span>(loglik<span class="sc">==</span><span class="fu">max</span>(loglik))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
   Beta    Rho   Eta     N Gamma     k loglik loglik.se
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
1  3.96 0.0602 0.562 38000     2    10  -104.    0.0273</code></pre>
</div>
</div>
<ul>
<li>In contrast to the local-search codes above, here we return only the endpoint of the search, together with the likelihood estimate and its standard error in a named vector.</li>
<li>The best result of this search had a likelihood of -104.3 with a standard error of 0.03.</li>
<li>This took 13.7 minutes altogether using 10 processors.</li>
</ul>
<p>Again, we attempt to visualize the global geometry of the likelihood surface using a scatterplot matrix. In particular, here we plot both the starting values (grey) and the IF2 estimates (red).</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/pairs_global1_c938d719f58521804e99a759485a372d">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(guesses) <span class="sc">|&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type=</span><span class="fu">if_else</span>(<span class="fu">is.na</span>(loglik),<span class="st">"guess"</span>,<span class="st">"result"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(type) <span class="ot">-&gt;</span> all</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(<span class="sc">~</span>loglik<span class="sc">+</span>Beta<span class="sc">+</span>Eta<span class="sc">+</span>Rho, <span class="at">data=</span>all, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.3</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">ifelse</span>(all<span class="sc">$</span>type<span class="sc">==</span><span class="st">"guess"</span>,<span class="fu">grey</span>(<span class="fl">0.5</span>),<span class="st">"red"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/pairs_global1-1.png" style="height:80.0%" width="2400" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>We see that optimization attempts from diverse remote starting points converge on a particular region in parameter space.</li>
<li>The estimates have comparable likelihoods, despite their considerable variability.</li>
<li>This gives us some confidence in our maximization procedure.</li>
</ul>
<p>The projections of the estimates give us `<code>poor man</code>s profiles’’:</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/pairs_global2_cb70905b99fe00f62b90e5b311615ff2">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>all <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(type<span class="sc">==</span><span class="st">"result"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Eta,<span class="at">y=</span>loglik))<span class="sc">+</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span><span class="fu">expression</span>(Eta),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">"poor man's profile likelihood"</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/pairs_global2-1.png" style="height:80.0%" width="2400" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="profile-likelihood" class="level1">
<h1>Profile likelihood</h1>
<section id="profile-likelihood-over-eta" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="profile-likelihood-over-eta">Profile likelihood over <span class="math inline">\(\eta\)</span></h2>
<ul>
<li>The curvature displayed in the upper envelope of the above plot suggests that there is indeed information in the data with respect to the susceptible fraction, <span class="math inline">\(\eta\)</span>.</li>
<li>To solidify this evidence, let’s compute a profile likelihood over this parameter.</li>
<li>Recall that this means determining, for each value of <span class="math inline">\(\eta\)</span>, the best likelihood that the model can achieve.</li>
<li>To do this, we’ll first bound the uncertainty by putting a box around the highest-likelihood estimates we’ve found so far.</li>
<li>Within this box, we’ll choose some random starting points, for each of several values of <span class="math inline">\(\eta\)</span>.</li>
</ul>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile1a_b3a7d5a935d2f473dc4692a1c1fb76e1">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">20</span>,loglik.se<span class="sc">&lt;</span><span class="dv">2</span>) <span class="sc">|&gt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(range) <span class="ot">-&gt;</span> box</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>box</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Beta Gamma        Rho  k        Eta     N
[1,]  1.824688     2 0.03405657 10 0.03628984 38000
[2,] 69.791919     2 0.60343428 10 0.99982180 38000
        loglik  loglik.se
[1,] -122.7423 0.01462075
[2,] -104.2847 0.56960880</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile1b_cd1e89297619c3c5743244eb3e5d98f1">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">freeze</span>(<span class="at">seed=</span><span class="dv">1196696958</span>,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">profile_design</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Eta=</span><span class="fu">seq</span>(<span class="fl">0.01</span>,<span class="fl">0.95</span>,<span class="at">length=</span><span class="dv">40</span>),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower=</span>box[<span class="dv">1</span>,<span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Rho"</span>)],</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper=</span>box[<span class="dv">2</span>,<span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Rho"</span>)],</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">nprof=</span><span class="dv">15</span>, <span class="at">type=</span><span class="st">"runif"</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  )) <span class="ot">-&gt;</span> guesses</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(guesses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/eta_profile1b-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>Now, we’ll start one independent sequence of iterated filtering operations from each of these points.</li>
<li>We’ll be careful to keep <span class="math inline">\(\eta\)</span> fixed.</li>
<li>This is accomplished by not giving this parameter a random perturbation in the <code>mif2</code> call.</li>
</ul>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile2_15e096bf61343a574a5e7107ffa997d1">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">guess=</span><span class="fu">iter</span>(guesses,<span class="st">"row"</span>), <span class="at">.combine=</span>rbind,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">830007657</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dofuture%</span> {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  mf1 <span class="sc">|&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">params=</span><span class="fu">c</span>(guess,fixed_params),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>,<span class="at">Rho=</span><span class="fl">0.02</span>)) <span class="sc">|&gt;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">Nmif=</span><span class="dv">100</span>,<span class="at">cooling.fraction.50=</span><span class="fl">0.3</span>) <span class="ot">-&gt;</span> mf</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    mf <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">5000</span>) <span class="sc">|&gt;</span> <span class="fu">logLik</span>()) <span class="sc">|&gt;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ll</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizing-profile-likelihood" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="visualizing-profile-likelihood">Visualizing profile likelihood</h2>
<p>As always, we save the results in our global database and plot the results.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(results) <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(loglik)) <span class="sc">|&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>loglik) <span class="sc">|&gt;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"measles_params.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile_pairs_154ef9ddb588a5651e12539360bb99ab">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">10</span>) <span class="ot">-&gt;</span> all</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(<span class="sc">~</span>loglik<span class="sc">+</span>Beta<span class="sc">+</span>Eta<span class="sc">+</span>Rho,<span class="at">data=</span>all,<span class="at">pch=</span><span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/eta_profile_pairs-1.png" style="height:80.0%" width="2400" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Plotting just the results of the profile calculation reveals that, while some of the IF2 runs either become “stuck” on local minima or run out of opportunity to reach the heights of the likelihood surface, many of the runs converge on high likelihoods.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile_plot1_35352c72205c3d7ad4a0dc4cf8fb6479">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Eta,<span class="at">y=</span>loglik))<span class="sc">+</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="fu">expression</span>(eta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/eta_profile_plot1-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>A closer look shows what at first appears to be quite a flat surface over much of the explored range of <span class="math inline">\(\eta\)</span>. Note that this appearance is due to the vertical scale, which is driven by the very low likelihoods associated with the smallest values of <span class="math inline">\(\eta\)</span>.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile_plot2_c9833fbb6314e925d040fe588fbbd0c2">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(loglik)) <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="fu">round</span>(Eta,<span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">rank</span>(<span class="sc">-</span>loglik)<span class="sc">&lt;</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">20</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Eta,<span class="at">y=</span>loglik))<span class="sc">+</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="fu">expression</span>(eta))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/eta_profile_plot2-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Focusing on just the top of the surface shows that, in fact, one is able to estimate <span class="math inline">\(\eta\)</span> using these data. In the following plot, the cutoff for the 95% confidence interval (CI) is shown.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile_plot3_87366a607d8d15d70487f93d68497392">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>maxloglik <span class="ot">&lt;-</span> <span class="fu">max</span>(results<span class="sc">$</span>loglik,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>ci.cutoff <span class="ot">&lt;-</span> maxloglik<span class="fl">-0.5</span><span class="sc">*</span><span class="fu">qchisq</span>(<span class="at">df=</span><span class="dv">1</span>,<span class="at">p=</span><span class="fl">0.95</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(loglik)) <span class="sc">|&gt;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="fu">round</span>(Eta,<span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">rank</span>(<span class="sc">-</span>loglik)<span class="sc">&lt;</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Eta,<span class="at">y=</span>loglik))<span class="sc">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="fu">expression</span>(eta)) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method=</span><span class="st">"loess"</span>,<span class="at">span=</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">color=</span><span class="st">"red"</span>,<span class="at">yintercept=</span>ci.cutoff)<span class="sc">+</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lims</span>(<span class="at">y=</span>maxloglik<span class="sc">-</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/eta_profile_plot3-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>As one varies <span class="math inline">\(\eta\)</span> across the profile, the model compensates by adjusting the other parameters.</li>
<li>It can be very instructive to understand how the model does this.</li>
<li>For example, how does the reporting efficiency, <span class="math inline">\(\rho\)</span>, change as <span class="math inline">\(\eta\)</span> is varied?</li>
<li>We can plot <span class="math inline">\(\rho\)</span> vs <span class="math inline">\(\eta\)</span> across the profile.</li>
<li>This is called a <em>profile trace</em>.</li>
</ul>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/eta_profile_eta_by_rho_41f60b638d163248bfbdceaf6b5d49ea">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.finite</span>(loglik)) <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="fu">round</span>(Eta,<span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">rank</span>(<span class="sc">-</span>loglik)<span class="sc">&lt;</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_ci=</span>loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="fl">1.92</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Eta,<span class="at">y=</span>Rho,<span class="at">color=</span>in_ci))<span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"inside 95% CI?"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span><span class="fu">expression</span>(eta),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y=</span><span class="fu">expression</span>(rho),</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">"profile trace"</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/eta_profile_eta_by_rho-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="profile-over-rho" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="profile-over-rho">Profile over <span class="math inline">\(\rho\)</span></h2>
<p>While the above profile trace is suggestive that the 95% CI for <span class="math inline">\(\rho\)</span> must be between roughly 4% and 20%, to confirm this, we should construct a proper profile likelihood over <span class="math inline">\(\rho\)</span>. We do so now.</p>
<p>This time, we will initialize the IF2 computations at points we have already established have high likelihoods.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/rho_profile1_f49fb33f79e4c47f3ea3778b8765e55c">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">cut=</span><span class="fu">round</span>(Rho,<span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">rank</span>(<span class="sc">-</span>loglik)<span class="sc">&lt;=</span><span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>loglik) <span class="sc">|&gt;</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>cut,<span class="sc">-</span>loglik,<span class="sc">-</span>loglik.se) <span class="ot">-&gt;</span> guesses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/rho_profile2_128300bfb677d54178fa11829960fd01">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">guess=</span><span class="fu">iter</span>(guesses,<span class="st">"row"</span>), <span class="at">.combine=</span>rbind,</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">2105684752</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dofuture%</span> {</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  mf1 <span class="sc">|&gt;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">params=</span>guess,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>,<span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>))) <span class="sc">|&gt;</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">Nmif=</span><span class="dv">100</span>,<span class="at">cooling.fraction.50=</span><span class="fl">0.3</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>() <span class="ot">-&gt;</span> mf</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    mf <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">5000</span>) <span class="sc">|&gt;</span> <span class="fu">logLik</span>()) <span class="sc">|&gt;</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ll</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>  mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="profile-over-rho-results" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="profile-over-rho-results">Profile over <span class="math inline">\(\rho\)</span>: results</h2>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/prof-rho1_670a40515d967c789e942e6e7490abf6">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/prof-rho1-1.png" style="height:80.0%" width="2400" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/unnamed-chunk-4_6aec387960446cc7a6621874020824ab">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/unnamed-chunk-4-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/rho_ci_9e7e12b91ba1a07645fcc5fee0bec7d4">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">qchisq</span>(<span class="at">df=</span><span class="dv">1</span>,<span class="at">p=</span><span class="fl">0.95</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">min=</span><span class="fu">min</span>(Rho),<span class="at">max=</span><span class="fu">max</span>(Rho)) <span class="ot">-&gt;</span> rho_ci</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data appear to be consistent with reporting efficiencies in the 3.4–16% range (95% CI).</p>
</section>
<section id="the-investigation-continues." class="level2">
<h2 class="anchored" data-anchor-id="the-investigation-continues.">The investigation continues.</h2>
</section>
</section>
<section id="making-predictions" class="level1">
<h1>Making predictions</h1>
<section id="parameter-estimates-as-model-predictions" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="parameter-estimates-as-model-predictions">Parameter estimates as model predictions</h2>
<ul>
<li>The estimated parameters are one kind of model prediction.</li>
<li>When we can estimate parameters using other data, we can test these predictions.</li>
<li>In the case of a highly contagious, immunizing childhood infection such as measles, we can obtain an estimate of the reporting efficiency, <span class="math inline">\(\rho\)</span> by simply regressing cumulative cases on cumulative births <span class="citation" data-cites="Anderson1991">(<a href="#ref-Anderson1991" role="doc-biblioref">Anderson and May 1991</a>)</span> over many years.</li>
<li>When we do this for Consett, we see that the reporting efficiency is roughly 60%.</li>
<li>Since such a value makes the outbreak data quite unlikely, the prediction does not appear to be borne out.</li>
<li>We can conclude that one or more of our model assumptions is inconsistent with the data.</li>
<li>Let’s revisit our assumption that the infectious period is known to be 0.5~wk.</li>
<li>Indeed, it would not be surprising were we to find that the <em>effective</em> infectious period, at the population scale, were somewhat shorter than the <em>clinical</em> infectious period.</li>
<li>For example, confinement of patients should reduce contact rates, and might therefore curtail the effective infectious period.</li>
<li>To investigate this, we’ll relax our assumption about the value of <span class="math inline">\(\gamma\)</span>.</li>
</ul>
</section>
</section>
<section id="searching-in-another-direction" class="level1">
<h1>Searching in another direction</h1>
<section id="another-global-search" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="another-global-search">Another global search</h2>
<p>We will estimate the model under the assumption that <span class="math inline">\(\rho=0.6\)</span>, but without making assumptions about the duration of the infectious period. As before, we’ll construct a random design of starting parameters.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/exp_global_search1_d04374594a3eb89e0245fb65c65a1380">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">freeze</span>(<span class="at">seed=</span><span class="dv">55266255</span>,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runif_design</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">5</span>,<span class="at">Gamma=</span><span class="fl">0.2</span>,<span class="at">Eta=</span><span class="dv">0</span>),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper=</span><span class="fu">c</span>(<span class="at">Beta=</span><span class="dv">80</span>,<span class="at">Gamma=</span><span class="dv">5</span>,<span class="at">Eta=</span><span class="fl">0.99</span>),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nseq=</span><span class="dv">1000</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">Rho=</span><span class="fl">0.6</span>, <span class="at">k=</span><span class="dv">10</span>, <span class="at">N=</span><span class="dv">38000</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> guesses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>For each of these starting points, we’ll run a series of IF2 computations.</li>
<li>Since we have gained some experience applying <code>mif2</code> to this model and these data, we have some expectation about how much computation is required.</li>
<li>In the following, we’ll use a lot more computational power than we have so far.</li>
</ul>
<p>For each of the starting points, we’ll first perform 100 IF2 iterations:</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/exp_global_search2a_ecd82f779f33b71e9b33ffe285dacc23">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mif2</span>(<span class="at">params=</span>guess, <span class="at">Np=</span><span class="dv">2000</span>, <span class="at">Nmif=</span><span class="dv">100</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cooling.fraction.50=</span><span class="fl">0.5</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">partrans=</span><span class="fu">parameter_trans</span>(</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">log=</span><span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Gamma"</span>),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">logit=</span><span class="st">"Eta"</span>), <span class="at">paramnames=</span><span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Gamma"</span>,<span class="st">"Eta"</span>),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>,<span class="at">Gamma=</span><span class="fl">0.02</span>,<span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>))) <span class="ot">-&gt;</span> mf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We use random perturbations of the same magnitude as before, taking care to transform the parameters we are estimating.</p>
<p>We adopt a <em>simulated tempering</em> approach (following a metallurgical analogy), in which we increase the size of the random perturbations some amount (i.e., “reheat”), and then continue cooling.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/exp_global_search2b_737daca38b4f9989ec412ff31fa29095">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>mf <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mif2</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Nmif=</span><span class="dv">100</span>,<span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.01</span>,<span class="at">Gamma=</span><span class="fl">0.01</span>,<span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.01</span>))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mif2</span>(</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Nmif=</span><span class="dv">100</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.005</span>,<span class="at">Gamma=</span><span class="fl">0.005</span>,<span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.005</span>))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> mf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We wrap the above in a <code>foreach</code> loop as before and take care to evaluate the likelihood at each end-point using <code>pfilter</code>.</p>
<p>See the <a href="./main.R"><code>R</code> code for this lesson</a> to see exactly how this is done.</p>
<p>The computations above required 55.8 minutes on 10 processors.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/another-search_096d3ae0951c55926694caa596d75b9f">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">20</span>) <span class="ot">-&gt;</span> all</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pairs</span>(<span class="sc">~</span>loglik<span class="sc">+</span>Rho<span class="sc">+</span>Gamma<span class="sc">+</span>Beta<span class="sc">+</span>Eta,<span class="at">data=</span>all,<span class="at">pch=</span><span class="dv">16</span>,<span class="at">cex=</span><span class="fl">0.3</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">col=</span><span class="fu">if_else</span>(<span class="fu">round</span>(all<span class="sc">$</span>Rho,<span class="dv">3</span>)<span class="sc">==</span><span class="fl">0.6</span>,<span class="dv">1</span>,<span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/another-search-1.png" style="height:80.0%" width="2400" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/poorman-gamma2_36a25e68c0f4d8efcfb17211d38d90ec">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">20</span>,loglik.se<span class="sc">&lt;</span><span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Gamma,<span class="at">y=</span>loglik))<span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"red"</span>,</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">yintercept=</span><span class="fu">max</span>(results<span class="sc">$</span>loglik)<span class="sc">-</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">qchisq</span>(<span class="at">df=</span><span class="dv">1</span>,<span class="at">p=</span><span class="fl">0.95</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/poorman-gamma2-1.png" style="height:80.0%" width="2400" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="profile-over-infectious-period" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="profile-over-infectious-period">Profile over infectious period</h2>
<p>To make inferences about <span class="math inline">\(\gamma\)</span>, we can again compute a profile likelihood. As before, we bound the region we will search:</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/gamma_profile1a_8a0a38ed449f2d6008565e1ed0cff82e">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    loglik<span class="sc">&gt;</span><span class="fu">max</span>(loglik)<span class="sc">-</span><span class="dv">20</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    loglik.se<span class="sc">&lt;</span><span class="dv">2</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(Rho<span class="fl">-0.6</span>)<span class="sc">&lt;</span><span class="fl">0.01</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(range) <span class="ot">-&gt;</span> box</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/gamma_profile1b_9677ae8a933dbf9b32b683cf6701a2da">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">freeze</span>(<span class="at">seed=</span><span class="dv">610408798</span>,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">profile_design</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gamma=</span><span class="fu">seq</span>(<span class="fl">0.2</span>,<span class="dv">2</span>,<span class="at">by=</span><span class="fl">0.1</span>),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower=</span>box[<span class="dv">1</span>,<span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Eta"</span>)],</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper=</span>box[<span class="dv">2</span>,<span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Eta"</span>)],</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">nprof=</span><span class="dv">100</span>, <span class="at">type=</span><span class="st">"runif"</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">|&gt;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">N=</span><span class="dv">38000</span>,</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Rho=</span><span class="fl">0.6</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">k=</span><span class="dv">10</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> guesses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/gamma_profile2_ebc6926b38889937df1e0fd5c2b2c2f5">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">foreach</span>(<span class="at">guess=</span><span class="fu">iter</span>(guesses,<span class="st">"row"</span>), <span class="at">.combine=</span>rbind,</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">.options.future=</span><span class="fu">list</span>(<span class="at">seed=</span><span class="dv">610408798</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%dofuture%</span> {</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  measSIR <span class="sc">|&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">params=</span>guess, <span class="at">Np=</span><span class="dv">2000</span>, <span class="at">Nmif=</span><span class="dv">100</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">partrans=</span><span class="fu">parameter_trans</span>(<span class="at">log=</span><span class="st">"Beta"</span>,<span class="at">logit=</span><span class="st">"Eta"</span>),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">paramnames=</span><span class="fu">c</span>(<span class="st">"Beta"</span>,<span class="st">"Eta"</span>), <span class="at">cooling.fraction.50=</span><span class="fl">0.5</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.02</span>,<span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.02</span>))</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">Nmif=</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">Nmif=</span><span class="dv">100</span>,<span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.01</span>,<span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.01</span>))) <span class="sc">|&gt;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mif2</span>(<span class="at">Nmif=</span><span class="dv">100</span>,<span class="at">rw.sd=</span><span class="fu">rw_sd</span>(<span class="at">Beta=</span><span class="fl">0.005</span>,<span class="at">Eta=</span><span class="fu">ivp</span>(<span class="fl">0.005</span>))) <span class="ot">-&gt;</span> mf</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">replicate</span>(<span class="dv">10</span>,mf <span class="sc">|&gt;</span> <span class="fu">pfilter</span>(<span class="at">Np=</span><span class="dv">5000</span>) <span class="sc">|&gt;</span> <span class="fu">logLik</span>()) <span class="sc">|&gt;</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logmeanexp</span>(<span class="at">se=</span><span class="cn">TRUE</span>) <span class="ot">-&gt;</span> ll</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  mf <span class="sc">|&gt;</span> <span class="fu">coef</span>() <span class="sc">|&gt;</span> <span class="fu">bind_rows</span>() <span class="sc">|&gt;</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(<span class="at">loglik=</span>ll[<span class="dv">1</span>],<span class="at">loglik.se=</span>ll[<span class="dv">2</span>])</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>} <span class="ot">-&gt;</span> results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="infectious-period-profile" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="infectious-period-profile">Infectious period profile</h2>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/gamma_profile_plot_3dbd9fdaa6e7f2ea0272aaaa46824551">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="fu">round</span>(Gamma,<span class="dv">2</span>)) <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">rank</span>(<span class="sc">-</span>loglik)<span class="sc">&lt;=</span><span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Gamma,<span class="at">y=</span>loglik))<span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="fu">expression</span>(gamma)) <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"red"</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">yintercept=</span><span class="fu">max</span>(results<span class="sc">$</span>loglik)<span class="sc">-</span><span class="fl">0.5</span><span class="sc">*</span><span class="fu">qchisq</span>(<span class="at">df=</span><span class="dv">1</span>,<span class="at">p=</span><span class="fl">0.95</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/gamma_profile_plot-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>This suggests that <span class="math inline">\(\rho=0.6\)</span> is consistent only with smaller values of <span class="math inline">\(\gamma\)</span>, and hence <em>longer</em> infectious periods than are possible if the duration of shedding is actually less than one week.</li>
<li>Thus the model is incapable of reconciling both an infectious period of less than one week and a reporting rate of 60%.</li>
<li><em>What structural changes to the model might we make to improve its ability to explain the data?</em></li>
</ul>
</section>
<section id="visualizing-predictions" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="visualizing-predictions">Visualizing predictions</h2>
<p>After all these analyses, we would like to visualize how exactly the model with the MLEs matches the data. We can do it by plotting the simulations with 95% the prediction interval.</p>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/unnamed-chunk-7_8a88282f68ce4dba7d0c73b6d9355a35">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="st">"measles_params.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(loglik <span class="sc">==</span> <span class="fu">max</span>(loglik)) <span class="sc">|&gt;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>loglik, <span class="sc">-</span>loglik.se) <span class="ot">-&gt;</span> best.params</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>measSIR <span class="sc">|&gt;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">simulate</span>(</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">params=</span><span class="fu">unlist</span>(best.params),</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">nsim=</span><span class="dv">1000</span>, <span class="at">format=</span><span class="st">"data.frame"</span>, <span class="at">include.data=</span><span class="cn">TRUE</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> sims</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="tmp//cache/viz-predictions_3f56498ab3b7080b0575852c191a0a38">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>sims <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">data=</span>.id<span class="sc">==</span><span class="st">"data"</span>) <span class="sc">|&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(week,data) <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">p=</span><span class="fu">c</span>(<span class="fl">0.025</span>,<span class="fl">0.5</span>,<span class="fl">0.975</span>),</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">value=</span><span class="fu">wquant</span>(reports,<span class="at">probs=</span>p),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">name=</span><span class="fu">c</span>(<span class="st">"lo"</span>,<span class="st">"med"</span>,<span class="st">"up"</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>p) <span class="sc">|&gt;</span> <span class="fu">pivot_wider</span>() <span class="sc">|&gt;</span> <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>week,<span class="at">y=</span>med,<span class="at">color=</span>data,<span class="at">fill=</span>data,<span class="at">ymin=</span>lo,<span class="at">ymax=</span>up))<span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()<span class="sc">+</span> <span class="fu">geom_ribbon</span>(<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">color=</span><span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"reports"</span>)<span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>,<span class="at">fill=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tmp//figure/viz-predictions-1.png" style="height:80.0%" width="1800" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="exercises" class="level1">
<h1>Exercises</h1>
<section id="fitting-the-seir-model" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="fitting-the-seir-model">Fitting the SEIR model</h2>
<p>In this exercise, you will estimate the parameters and likelihood of the SEIR model you implemented in the earlier lessons by following the template above. Purely for the sake of simplicity, you may assume that the values of <span class="math inline">\(\gamma\)</span> and <span class="math inline">\(k\)</span> are known. To do this efficiently, we will make use of a system of <em>run-levels</em>. At each run-level, we will select some number of particles (<code>Np</code>), number of IF2 iterations (<code>Nmif</code>), and number of starting guesses, to achieve a particular result.</p>
<ol type="1">
<li>First, conduct a local search and compute the likelihood at the end of each <code>mif2</code> run, as shown above. Use only as many parallel <code>mif2</code> computations as you have processors on your computer (or perhaps somewhat fewer). Track the time used and compute the amount of time used per cpu per IF2 iteration per 1000 particles. (Recall that one particle filter computation is roughly equal to a IF2 iteration in computational complexity if they both use the same number of particles.)</li>
<li>At run-level 1, we want a quick calculation that verifies that the codes are working as expected. Using the expense estimates you generated in Step~(@ref(it:zero)), choose a number of IF2 iterations so that you can do a very crude “global search” that will complete in two or three minutes. Do not reduce <code>Np</code> drastically, as we don`t want to degrade the performance of the individual IF2 computations. Run your global search with these settings. This serves to debug your global search code.</li>
<li>At run-level 2, we want a computation that gives us some results we can begin to interpret, but that is still as quick as possible. Choose <code>Nmif</code> and the number of random starts so that you can obtain the beginnings of a global search of the parameter space in one hour or less. Run your global search with these settings and plot the results.</li>
<li>Run-level 3 is intended for final or near-final results. You may want to tune your settings (<code>Nmif</code>, <code>Np</code>, <code>rw.sd</code>, <code>cooling.fraction.50</code>) at this point, based on what you found at run-level 2. Decide how much time in the next 18 hours is available to you for a computation. Choose the number of starting guesses so that you can obtain as thorough a global search as possible within this period. Run your global search and identify a maximum likelihood estimate.</li>
<li>How does the SEIR model compare with the SIR model? Discuss the overall quality of the fit as well as important differences in how the two models are explaining the data.</li>
</ol>
<p><a href="./Q_fit_seir.html">Worked solution to the Exercise</a></p>
</section>
<section id="fitting-all-parameters-of-the-sir-model" class="level2">
<h2 class="anchored" data-anchor-id="fitting-all-parameters-of-the-sir-model">Fitting all parameters of the SIR model</h2>
<p>In all of the foregoing, we have assumed a fixed value of the dispersion parameter, <span class="math inline">\(k\)</span>, of the negative binomial measurement model. We’ve also fixed one or the other of <span class="math inline">\(\gamma\)</span>, <span class="math inline">\(\eta\)</span>. Now attempt to estimate all the parameters simultaneously. To accomplish this, use the same system of run-levels as in the previous Exercise.</p>
<p>How much is the fit improved? How has the model’s explanation of the data changed?</p>
<p><a href="./Q_fit_all.html">Worked solution to the Exercise</a></p>
</section>
<section id="construct-a-profile-likelihood" class="level2">
<h2 class="anchored" data-anchor-id="construct-a-profile-likelihood">Construct a profile likelihood</h2>
<p>How strong is the evidence about the contact rate, <span class="math inline">\(\beta\)</span>, given this model and data? Use <code>mif2</code> to construct a profile likelihood. Due to time constraints, you may be able to compute only a preliminary version.</p>
<p>It is also possible to profile over the basic reproduction number, <span class="math inline">\(R_0=\beta /\gamma\)</span>. Is this more or less well determined than <span class="math inline">\(\beta\)</span> for this model and data?</p>
</section>
<section id="checking-the-source-code" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="checking-the-source-code">Checking the source code</h2>
<p>Check the source code for the <code>measSIR</code> pomp object, using the <code>spy</code> command.</p>
<ol type="1">
<li>Does the code implement the model described?</li>
</ol>
<p>It can be surprisingly hard to make sure that the written equations and the code are perfectly matched. Papers should be written to be readable, and therefore people rarely choose to clutter papers with numerical details which they hope and believe are scientifically irrelevant.</p>
<ol start="2" type="1">
<li>What problems can arise due to the conflict between readability and reproducibility?</li>
<li>What solutions are available?</li>
</ol>
<p><a href="./Q_check_code.html">Worked solution to the Exercise</a></p>
</section>
<section id="beware-errors-in-rprocess" class="level2">
<h2 class="anchored" data-anchor-id="beware-errors-in-rprocess">Beware errors in <code>rprocess</code></h2>
<p>Suppose that there is an error in the coding of <code>rprocess</code> and suppose that plug-and-play statistical methodology is used to infer parameters. As a conscientious researcher, you carry out a simulation study to check the soundness of your inference methodology on this model. To do this, you use <code>simulate</code> to generate realizations from the fitted model and you check that your parameter inference procedure recovers the known parameters, up to some statistical error.</p>
<ol type="1">
<li>Will this procedure help to identify the error in <code>rprocess</code>?</li>
<li>If not, how might you debug <code>rprocess</code>?</li>
<li>What research practices help minimize the risk of errors in simulation code?</li>
</ol>
<p><a href="./Q_error_in_rprocess.html">Worked solution to the Exercise</a></p>
</section>
<section id="choosing-the-algorithmic-settings-for-if2" class="level2">
<h2 class="anchored" data-anchor-id="choosing-the-algorithmic-settings-for-if2">Choosing the algorithmic settings for IF2</h2>
<p>Have a look at <a href="./if2_settings.html">our advice on tuning IF2</a>. An exercise at the end of the linked document invites you to test this advice on the Consett measles example.</p>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<section id="references-1" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="references-1">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Anderson1991" class="csl-entry" role="listitem">
Anderson, R. M., and R. M. May. 1991. <em>Infectious Diseases of Humans</em>. Oxford: Oxford Univesity Press.
</div>
<div id="ref-Andrieu2010" class="csl-entry" role="listitem">
Andrieu, Christophe, Arnaud Doucet, and Roman Holenstein. 2010. <span>“Particle <span>Markov</span> Chain <span>Monte Carlo</span> Methods.”</span> <em>J R Stat Soc B</em> 72 (3): 269–342. <a href="https://doi.org/10.1111/j.1467-9868.2009.00736.x">https://doi.org/10.1111/j.1467-9868.2009.00736.x</a>.
</div>
<div id="ref-He2010" class="csl-entry" role="listitem">
He, Daihai, Edward L. Ionides, and Aaron A. King. 2010. <span>“Plug-and-Play Inference for Disease Dynamics: Measles in Large and Small Populations as a Case Study.”</span> <em>J R Soc Interface</em> 7 (June): 271–83. <a href="https://doi.org/10.1098/rsif.2009.0151">https://doi.org/10.1098/rsif.2009.0151</a>.
</div>
<div id="ref-Ionides2006" class="csl-entry" role="listitem">
Ionides, E. L., C. Bretó, and Aaron A. King. 2006. <span>“Inference for Nonlinear Dynamical Systems.”</span> <em>Proc Natl Acad Sci</em> 103 (49): 18438–43. <a href="https://doi.org/10.1073/pnas.0603181103">https://doi.org/10.1073/pnas.0603181103</a>.
</div>
<div id="ref-Ionides2015" class="csl-entry" role="listitem">
Ionides, Edward L., Dao Nguyen, Yves Atchadé, Stilian Stoev, and Aaron A. King. 2015. <span>“Inference for Dynamic and Latent Variable Models via Iterated, Perturbed <span>Bayes</span> Maps.”</span> <em>Proc Natl Acad Sci</em> 112 (3): 719–24. <a href="https://doi.org/10.1073/pnas.1410597112">https://doi.org/10.1073/pnas.1410597112</a>.
</div>
<div id="ref-King2016" class="csl-entry" role="listitem">
King, Aaron A., Dao Nguyen, and Edward L. Ionides. 2016. <span>“Statistical Inference for Partially Observed <span>Markov</span> Processes via the <span>R</span> Package Pomp.”</span> <em>J Stat Softw</em> 69 (12): 1–43. <a href="https://doi.org/10.18637/jss.v069.i12">https://doi.org/10.18637/jss.v069.i12</a>.
</div>
<div id="ref-Shrestha2011" class="csl-entry" role="listitem">
Shrestha, Sourya, Aaron A. King, and Pejman Rohani. 2011. <span>“Statistical Inference for Multi-Pathogen Systems.”</span> <em>PLoS Comput Biol</em> 7 (8): e1002135. <a href="https://doi.org/10.1371/journal.pcbi.1002135">https://doi.org/10.1371/journal.pcbi.1002135</a>.
</div>
<div id="ref-Toni2009" class="csl-entry" role="listitem">
Toni, Tina, David Welch, Natalja Strelkowa, Andreas Ipsen, and Michael P. H. Stumpf. 2009. <span>“Approximate <span>Bayesian</span> Computation Scheme for Parameter Inference and Model Selection in Dynamical Systems.”</span> <em>J R Soc Interface</em> 6 (31): 187–202. <a href="https://doi.org/10.1098/rsif.2008.0172">https://doi.org/10.1098/rsif.2008.0172</a>.
</div>
</div>
</section>
<section id="license-acknowledgments-and-links" class="level2 allowframebreaks">
<h2 class="allowframebreaks anchored" data-anchor-id="license-acknowledgments-and-links">License, acknowledgments, and links</h2>
<ul>
<li><p>This lesson is prepared for the <a href="https://kingaa.github.io/sbied/">Simulation-based Inference for Epidemiological Dynamics</a> module at the Summer Institute in Statistics and Modeling in Infectious Diseases, <a href="https://www.biostat.washington.edu/suminst/sismid">SISMID</a>.</p></li>
<li><p>The materials build on <a href="../acknowledge.html">previous versions of this course and related courses</a>.</p></li>
<li><p>Licensed under the <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial license</a>. Please share and remix non-commercially, mentioning its origin. </p></li>
<li><p>Produced with R version 4.3.2 and pomp version 5.10.</p></li>
<li><p>Compiled on 2024-06-17.</p></li>
</ul>
<p><a href="index.html">Back to Lesson</a></p>
<p><a href="./main.R"><code>R</code> code for this lesson</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>